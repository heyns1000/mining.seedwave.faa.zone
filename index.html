<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Fruitful™ | MineNest™ Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.js"></script>
    <!-- PayPal SDK Integration: Load PayPal JavaScript SDK for smart buttons -->
    <!-- Replace 'YOUR_CLIENT_ID' with a real PayPal Client ID for live transactions. -->
    <!-- For demonstration, 'sb' (sandbox) is used as a placeholder client ID. -->
    <script src="https://www.paypal.com/sdk/js?client-id=sb&currency=USD"></script>
    <style>
        /* Define Fruitful Global Color Palette and Base Styles */
        :root {
            /* Dark Mode Defaults */
            --primary-color: #0071e3; /* Apple Blue */
            --secondary-color: #B8860B; /* Corporate Gold for Mining accent */
            --text-color-light: #f5f5f7; /* Light text on dark backgrounds */
            --text-color-dark: #1d1d1f; /* Dark text on light backgrounds - used for some components that flip colors */
            --bg-color-dark: #1a1a1c; /* Deep black/dark grey */
            --card-bg-dark: #2a2a2e; /* Darker grey for dark cards */
            --border-color-dark: #3a3a3e; /* Subtle dark border */
            --accent-gold: #B8860B; /* Corporate gold accent */
            --status-active: #30d158; /* Green for active */
            --status-pending: #f59e0b; /* Amber for pending */
            --status-draft: #6e6e73; /* Gray for draft */
            --status-error: #ef4444; /* Red for error */

            /* Light Mode Variables (will override dark mode) - Inspired by mining HTML */
            --light-primary-color: #0071e3; /* Apple Blue */
            --light-secondary-color: #B8860B; /* Corporate Gold */
            --light-text-color-light: #1d1d1f; /* Dark text for light mode body */
            --light-text-color-dark: #1d1d1f; /* Dark text for light mode body content */
            --light-bg-color-dark: #f5f5f7; /* Very light gray, almost white */
            --light-card-bg-dark: #ffffff; /* White for light cards */
            --light-border-color-dark: #e8e8ed; /* Subtle light border */
        }

        /* Base Body Styling - Defaults to dark mode based on root variables */
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color-dark);
            color: var(--text-color-light); /* Main text color based on mode */
            min-height: 100vh;
            display: flex;
            transition: background-color 0.3s ease, color 0.3s ease; /* Smooth transition for theme change */
            margin: 0;
            padding: 0;
        }

        /* Light Mode specific overrides */
        body.light-mode {
            background-color: var(--light-bg-color-dark);
            color: var(--light-text-color-light);

            /* Overrides for specific components in light mode */
            .sidebar, .panel, .metric-card, .project-card, .chart-container, .custom-modal-content, .company-select-card {
                background-color: var(--light-card-bg-dark);
                border-color: var(--light-border-color-dark);
                box-shadow: 0 4px 15px rgba(0,0,0,0.08); /* Lighter shadow */
            }
            .sidebar-header .logo-text {
                color: var(--light-text-color-light); /* Fruitful part darker */
            }
            .sidebar-header .logo-text span { /* MineNest part in gold */
                color: var(--light-secondary-color);
            }
            .nav-list a {
                color: var(--light-text-color-dark); /* Darker nav text */
            }
            .nav-list a:hover {
                background-color: rgba(0, 113, 227, 0.05); /* Lighter hover background */
                color: var(--light-primary-color);
            }
            .nav-list a.active {
                background-color: var(--light-primary-color);
                color: white;
            }
            .nav-icon {
                color: var(--light-secondary-color); /* Gold remains contrast */
            }
            .panel h3, .panel h4 {
                color: var(--light-secondary-color); /* Gold for headings */
            }
            .panel p, .project-card p, .api-key-value, .form-control label, .form-control input, .form-control select, .form-control textarea {
                color: var(--light-text-color-dark); /* Darker text for readability */
            }
            .form-control input[type="text"],
            .form-control input[type="email"],
            .form-control input[type="password"],
            .form-control select,
            .form-control textarea,
            .form-control input[type="number"] { /* Added number type */
                background-color: #ebebeb; /* Lighter input fields */
                border-color: #d1d1d1;
                color: var(--light-text-color-light); /* Input text darker */
            }
            .project-card {
                background-color: #f0f0f0; /* Lighter project cards in light mode */
                border-color: #d1d1d1;
            }
            .project-actions button {
                color: white; /* Button text white */
                background-color: var(--light-secondary-color); /* Gold buttons */
            }
            .project-actions button:hover {
                background-color: #a37209; /* Darker gold on hover */
            }
            .project-actions button.secondary {
                color: var(--light-primary-color);
                border-color: var(--light-primary-color);
                background-color: transparent;
            }
            .project-actions button.secondary:hover {
                background-color: rgba(0, 113, 227, 0.08);
            }
            .api-key-table th {
                background-color: #e8e8ed;
            }
            .api-key-table tr:hover {
                background-color: #f0f0f0;
            }
            .security-note {
                background-color: rgba(239, 68, 68, 0.08);
                color: #dc2626;
            }
            .template-preview-frame {
                background-color: #f8f8f8; /* Lighter iframe background */
            }
            .editor-container {
                background-color: var(--light-bg-color-dark);
            }
            .editor-header {
                background-color: var(--light-card-bg-dark);
                border-bottom: 1px solid var(--light-border-color-dark);
            }
            .code-editor, .preview-area {
                background-color: var(--light-card-bg-dark);
                border-color: var(--light-border-color-dark);
            }
            .code-editor textarea,
            #editorSectionTopicInput,
            #editorRephraseTextInput,
            #editorGeneratedContentOutput,
            .editor-content-area input {
                background-color: #ebebeb;
                border-color: #d1d1d1;
                color: var(--light-text-color-dark);
            }
            .editor-actions button {
                color: var(--light-text-color-dark); /* Dark button text */
            }
            .editor-actions button.secondary {
                color: var(--light-primary-color);
                border-color: var(--light-primary-color);
            }
            .editor-actions button.secondary:hover {
                background-color: rgba(0, 113, 227, 0.08);
            }
            .copy-square pre {
                color: var(--light-text-color-dark);
            }
            .toggle-section-btn span {
                color: var(--light-text-color-dark) !important;
            }
        }


        /* Sidebar Styling */
        .sidebar {
            width: 280px; /* Wider sidebar */
            background-color: var(--card-bg-dark);
            padding: 1.5rem 1rem;
            border-right: 1px solid var(--border-color-dark);
            box-shadow: 2px 0 10px rgba(0,0,0,0.3);
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
            overflow-y: auto; /* Scrollable sidebar */
        }
        .sidebar-header {
            text-align: center;
            margin-bottom: 2rem;
            position: relative; /* For theme toggle button positioning */
        }
        .sidebar-header .theme-toggle {
            position: absolute;
            top: 0;
            right: 0;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-color-light); /* Icon color changes with theme */
            transition: color 0.3s ease;
        }
        .sidebar-header .theme-toggle:hover {
            color: var(--primary-color);
        }
        .sidebar-header .logo-text {
            font-size: 1.8rem;
            font-weight: 800;
            color: #FFFFFF; /* Fruitful part in white */
            line-height: 1; /* Adjust line height for better alignment */
        }
        .sidebar-header .logo-text span {
            color: var(--secondary-color); /* MineNest part in Gold */
            font-size: 0.8em; /* Make 'MineNest' slightly smaller relative to 'Fruitful' */
            letter-spacing: -0.02em; /* Tighter spacing for "MineNest" */
        }
        .nav-list a {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.8rem 1rem;
            margin-bottom: 0.5rem;
            border-radius: 8px;
            color: var(--text-color-light); /* Nav text color changes with theme */
            text-decoration: none;
            font-weight: 500;
            transition: all 0.2s ease-in-out;
            background-color: transparent;
        }
        .nav-list a:hover {
            background-color: rgba(0, 113, 227, 0.1);
            color: var(--primary-color);
        }
        .nav-list a.active {
            background-color: var(--primary-color);
            color: white;
            font-weight: 600;
            box-shadow: 0 2px 8px rgba(0, 113, 227, 0.3);
        }
        .nav-list a.active .nav-icon {
            color: white;
        }
        .nav-icon {
            font-size: 1.2rem;
            color: var(--secondary-color);
            transition: color 0.2s ease;
        }

        /* Main Content Area */
        .main-content {
            flex-grow: 1;
            padding: 2.5rem;
            background-color: var(--bg-color-dark); /* Background changes with theme */
            overflow-y: auto; /* Scrollable main content */
        }

        /* General Panel Styling */
        .panel {
            background-color: var(--card-bg-dark); /* Panel background changes with theme */
            padding: 2rem;
            border-radius: 12px;
            margin-bottom: 2.5rem;
            border: 1px solid var(--border-color-dark); /* Border changes with theme */
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
        .panel h3, .panel h4 {
            color: var(--secondary-color);
            font-weight: 700;
            margin-top: 0;
            margin-bottom: 1.5rem;
        }
        .panel h3 { font-size: 1.8rem; }
        .panel h4 { font-size: 1.4rem; }
        .panel p {
            color: var(--text-color-light); /* Paragraph text changes with theme */
            line-height: 1.6;
        }

        /* Metric Cards */
        .metric-card {
            background-color: var(--card-bg-dark); /* Metric card background changes with theme */
            padding: 1.5rem;
            border-radius: 10px;
            border: 1px solid var(--border-color-dark); /* Border changes with theme */
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        /* Light mode specific override for metric card background */
        body.light-mode .metric-card {
            background-color: var(--light-card-bg-dark);
            border-color: var(--light-border-color-dark);
        }
        .metric-card h4 {
            font-size: 1rem;
            color: var(--text-color-light); /* Metric title changes with theme */
            margin-bottom: 0.5rem;
            font-weight: 600;
        }
        .metric-card p {
            font-size: 2.5rem;
            font-weight: 800;
            color: var(--primary-color);
            margin: 0;
            line-height: 1.1;
        }

        /* Project Grid */
        .project-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1.5rem;
        }
        .project-card {
            background-color: #1a1a1a; /* Project card background (slightly lighter dark) */
            padding: 1.5rem;
            border-radius: 10px;
            border: 1px solid #3a3a3e; /* Border based on this card's color */
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        /* Light mode specific override for project card background */
        body.light-mode .project-card {
            background-color: #f0f0f0; /* Lighter project cards in light mode */
            border-color: #d1d1d1;
        }

        .project-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 15px rgba(0,0,0,0.3);
        }
        .project-card h4 {
            font-size: 1.2rem;
            color: var(--primary-color);
            margin-bottom: 0.5rem;
        }
        .project-card p {
            font-size: 0.9rem;
            color: var(--text-color-light); /* Project card text color changes with theme */
            margin-bottom: 0.4rem;
        }
        /* Light mode specific override for project card text */
        body.light-mode .project-card p {
            color: var(--text-color-dark);
        }
        .project-status {
            font-weight: 600;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            display: inline-block;
            font-size: 0.8rem;
        }
        .status-live { background-color: var(--status-active); color: white; }
        .status-pending { background-color: var(--status-pending); color: white; }
        .status-draft { background-color: var(--status-draft); color: white; }
        .status-error { background-color: var(--status-error); color: white; }
        .project-actions button {
            background-color: var(--secondary-color);
            color: white;
            padding: 0.6rem 1rem;
            border-radius: 6px;
            font-weight: 600;
            font-size: 0.9rem;
            margin-top: 0.8rem;
            margin-right: 0.5rem;
            transition: all 0.2s ease;
            border: none;
            cursor: pointer;
        }
        .project-actions button:hover {
            background-color: #a37209; /* Darker gold for hover */
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(184,134,11,0.3);
        }
        .project-actions button.secondary {
            background-color: transparent;
            color: var(--primary-color);
            border: 1px solid var(--primary-color);
        }
        .project-actions button.secondary:hover {
            background-color: rgba(0, 113, 227, 0.1);
            color: var(--primary-color);
            transform: translateY(-2px);
        }

        /* Form styling */
        .form-control {
            margin-bottom: 1.5rem;
            text-align: left;
        }
        .form-control label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--text-color-light); /* Label text changes with theme */
        }
        body.light-mode .form-control label {
            color: var(--text-color-dark); /* Darker labels in light mode */
        }
        .form-control input[type="text"],
        .form-control input[type="email"],
        .form-control input[type="password"],
        .form-control select,
        .form-control textarea,
        .form-control input[type="number"] { /* Added number type */
            width: 100%;
            padding: 0.75rem;
            border-radius: 8px;
            border: 1px solid var(--border-color-dark);
            background-color: #3a3a3e; /* Input background changes with theme */
            color: var(--text-color-light); /* Input text color changes with theme */
            font-size: 1rem;
            transition: border-color 0.2s ease, background-color 0.2s ease, color 0.2s ease;
        }
        body.light-mode .form-control input, body.light-mode .form-control select, body.light-mode .form-control textarea {
            background-color: #ebebeb; /* Lighter input fields */
            border-color: #d1d1d1;
            color: var(--text-color-dark);
        }
        .form-control input:focus, .form-control select:focus, .form-control textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(0, 113, 227, 0.3);
        }
        .form-action-button {
            background-color: var(--secondary-color);
            color: white;
            padding: 0.8rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            font-size: 1rem;
            margin-top: 1rem;
            transition: all 0.2s ease;
            border: none;
            cursor: pointer;
        }
        .form-action-button:hover {
            background-color: #a37209; /* Darker gold hover */
            transform: translateY(-2px);
            box-shadow: 0 2px 8px rgba(184,134,11,0.3);
        }
        .form-action-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
        }

        /* Analytics Chart specific styling */
        .chart-container {
            position: relative;
            height: 300px; /* Fixed height for charts */
            background-color: var(--bg-color-dark); /* Dark background for charts */
            padding: 1rem;
            border-radius: 8px;
            border: 1px solid var(--border-color-dark);
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        /* Light mode specific override for chart background */
        body.light-mode .chart-container {
            background-color: #f0f0f0;
            border-color: #d1d1d1;
        }

        /* API Keys table styling */
        .api-key-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1.5rem;
            text-align: left;
        }
        .api-key-table th, .api-key-table td {
            padding: 0.8rem;
            border-bottom: 1px solid var(--border-color-dark); /* Border changes with theme */
        }
        body.light-mode .api-key-table th, body.light-mode .api-key-table td {
            border-color: var(--light-border-color-dark);
        }
        .api-key-table th {
            background-color: #1a1a1a; /* Header background (slightly lighter dark) */
            color: var(--secondary-color);
            font-weight: 600;
        }
        body.light-mode .api-key-table th {
            background-color: #e8e8ed;
        }
        .api-key-table tr:hover {
            background-color: #3a3a3e; /* Row hover background */
        }
        body.light-mode .api-key-table tr:hover {
            background-color: #f0f0f0;
        }
        .api-key-value {
            font-family: 'monospace';
            font-size: 0.85rem;
            color: var(--text-color-light); /* Key value text changes with theme */
            word-break: break-all;
        }
        body.light-mode .api-key-value {
            color: var(--text-color-dark);
        }
        .security-note {
            background-color: #ef444420; /* Light red background */
            border-left: 4px solid var(--status-error);
            padding: 1rem;
            border-radius: 8px;
            margin-top: 1.5rem;
            color: #ef4444; /* Red text */
            font-size: 0.9rem;
            text-align: left;
        }


        /* Utility for hidden views */
        .view-hidden {
            display: none;
        }

        /* Custom Modal for Alerts */
        .custom-modal-overlay {
            position: fixed;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.75);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            z-index: 1000; /* Ensure it's on top */
            opacity: 0; /* Start hidden for fade effect */
            visibility: hidden; /* Prevent interaction when hidden */
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .custom-modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        .custom-modal-content {
            background-color: var(--card-bg-dark); /* Modal background changes with theme */
            color: var(--text-color-light); /* Modal text changes with theme */
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
            text-align: center;
            max-width: 400px;
            width: 100%;
            border: 1px solid var(--border-color-dark); /* Border changes with theme */
            transform: translateY(-20px); /* Start slightly up for animation */
            opacity: 0;
            transition: transform 0.3s ease, opacity 0.3s ease;
        }
        body.light-mode .custom-modal-content {
            background-color: var(--light-card-bg-dark);
            color: var(--text-color-dark);
            border-color: var(--light-border-color-dark);
        }
        .custom-modal-overlay.active .custom-modal-content {
            transform: translateY(0);
            opacity: 1;
        }
        .custom-modal-content p {
            margin-bottom: 1.5rem;
            font-size: 1.1rem;
        }


        /* Loading Spinner */
        .loading-spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 0.8s linear infinite;
            display: inline-block;
            vertical-align: middle;
            margin-left: 0.5rem;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Template Preview Modal */
        #templatePreviewModal .template-preview-header {
            background-color: var(--primary-color);
            color: white;
            padding: 1rem 1.5rem;
            border-top-left-radius: 12px;
            border-top-right-radius: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        #templatePreviewModal .template-preview-header h3 {
            color: white;
            margin: 0;
        }
        #templatePreviewModal .close-preview-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: white;
            cursor: pointer;
            transition: transform 0.2s ease;
        }
        #templatePreviewModal .close-preview-btn:hover {
            transform: scale(1.1);
        }
        #templatePreviewModal .template-preview-body {
            padding: 1.5rem;
            background-color: var(--card-bg-dark);
        }
        #templatePreviewModal .template-preview-frame {
            width: 100%;
            height: 400px; /* Fixed height for preview */
            border: 1px solid var(--border-color-dark);
            border-radius: 8px;
            background-color: #1a1a1c; /* Dark background for iframe */
        }
        #templatePreviewModal .template-preview-actions {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-top: 1.5rem;
        }
        .btn-primary {
            background-color: var(--secondary-color);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .btn-primary:hover {
            background-color: #a37209; /* Darker gold */
            transform: translateY(-1px);
        }
        .btn-secondary {
            background-color: var(--status-draft);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .btn-secondary:hover {
            background-color: #525257;
            transform: translateY(-1px);
        }

        /* Ecosystem Map Styling */
        .copy-square {
            position: relative;
            background-color: #3a3a3e;
            border-radius: 8px;
            padding: 0.75rem 1rem;
            margin-top: 0.75rem;
            border: 1px solid var(--border-color-dark);
        }
        body.light-mode .copy-square {
            background-color: #e8e8ed;
            border-color: #d1d1d1;
        }
        .copy-square .copy-button {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background-color: var(--primary-color);
            color: white;
            padding: 0.3rem 0.6rem;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 500;
            cursor: pointer;
            border: none;
            transition: background-color 0.2s ease;
            opacity: 0; /* Hidden by default */
            transition: opacity 0.2s ease;
        }
        .copy-square:hover .copy-button {
            opacity: 1; /* Show on hover */
        }
        .copy-square .copy-button:hover {
            background-color: #005bb5;
        }
        .copy-square pre.conversation-code-block {
            background: none;
            border: none;
            color: var(--text-color-light); /* Ensure text is visible in dark mode */
            padding: 0;
            margin: 0;
            font-size: 0.85rem;
            white-space: pre-wrap; /* Preserve formatting but wrap long lines */
            word-break: break-all; /* Break long words if necessary */
            padding-right: 40px; /* Make space for the copy button */
        }
        body.light-mode .copy-square pre.conversation-code-block {
            color: var(--text-color-dark);
        }

        .toggle-section-btn {
            background-color: transparent;
            border: none;
            cursor: pointer;
            width: 100%;
            text-align: left;
            padding: 0.5rem 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--primary-color); /* Matches current active nav link or primary color */
            transition: color 0.2s ease;
        }
        body.light-mode .toggle-section-btn {
            color: var(--light-primary-color);
        }
        .toggle-section-btn:hover {
            color: var(--primary-color);
        }
        .toggle-section-btn i {
            margin-left: 0.5rem;
            transition: transform 0.2s ease;
        }
        .toggle-section-btn i.fa-chevron-up {
            transform: rotate(180deg);
        }
        .repo-content-section {
            padding-left: 1rem;
            border-left: 2px solid var(--border-color-dark); /* Indent and show hierarchy */
            margin-top: 1rem;
            padding-top: 0.5rem;
        }
        body.light-mode .repo-content-section {
            border-color: var(--light-border-color-dark);
        }
        .repo-content-section .toggle-section-btn {
            font-size: 1rem; /* Smaller for nested levels */
            font-weight: 500;
            color: var(--text-color-light); /* Nested sections use lighter text color */
        }
        body.light-mode .repo-content-section .toggle-section-btn {
            color: var(--text-color-dark);
        }

        /* Ecosystem Map specific section-intro and section-title */
        #ecosystem-map-view .section-title {
            color: var(--secondary-color);
            font-size: 2.2rem;
            font-weight: 800;
        }
        #ecosystem-map-view .section-intro {
            color: var(--text-color-light);
            text-align: center;
            font-size: 1.1rem;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
        }
        body.light-mode #ecosystem-map-view .section-intro {
            color: var(--text-color-dark);
        }

        /* Global Checkout Styling (Applied to global-checkout-view after move) */
        #global-checkout-view .checkout-panel,
        #global-checkout-view #checkout-step-1,
        #global-checkout-view #checkout-step-2,
        #global-checkout-view #checkout-step-3 {
            background-color: var(--card-bg-dark);
            border: 1px solid var(--border-color-dark);
            padding: 2.5rem;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            text-align: center;
        }
        #global-checkout-view .step-indicator {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background-color: var(--primary-color);
            color: white;
            font-weight: bold;
            margin-right: 0.75rem;
        }
        #global-checkout-view .checkout-input {
            width: 100%;
            padding: 0.75rem;
            border-radius: 8px;
            border: 1px solid var(--border-color-dark);
            background-color: #3a3a3e;
            color: var(--text-color-light);
            font-size: 1rem;
        }
        #global-checkout-view .checkout-button {
            background-color: var(--secondary-color);
            color: white;
            padding: 0.8rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            font-size: 1rem;
            margin-top: 1.5rem;
            transition: all 0.2s ease;
            border: none;
            cursor: pointer;
        }
        #global-checkout-view .checkout-button:hover {
            background-color: #a37209; /* Darker gold */
            transform: translateY(-2px);
            box-shadow: 0 2px 8px rgba(184,134,11,0.3);
        }

        /* Editor Workspace Styling */
        .editor-container {
            display: flex;
            flex-direction: column;
            height: calc(100vh - 5rem); /* Adjust based on main-content padding */
            background-color: var(--card-bg-dark);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            border: 1px solid var(--border-color-dark);
        }
        .editor-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 1.5rem;
            background-color: #1a1a1a; /* Slightly lighter dark for header */
            color: white;
            font-size: 1.2rem;
            font-weight: 600;
            border-bottom: 1px solid var(--border-color-dark);
        }
        .editor-content-area {
            display: flex;
            flex-grow: 1;
            overflow: hidden; /* Prevent content overflow */
        }
        .code-editor, .preview-area {
            flex: 1;
            padding: 1.5rem;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        .code-editor {
            border-right: 1px solid var(--border-color-dark);
        }
        .code-editor textarea {
            background-color: #3a3a3e;
            border: 1px solid var(--border-color-dark);
            color: var(--text-color-light);
            padding: 0.75rem;
            border-radius: 8px;
            font-family: 'monospace';
            font-size: 0.9rem;
            flex-grow: 1; /* Allow textarea to take available height */
            min-height: 150px; /* Minimum height for code areas */
            resize: vertical; /* Allow vertical resizing */
        }
        .preview-area iframe {
            width: 100%;
            flex-grow: 1; /* Allow iframe to take available height */
            border: 1px solid var(--border-color-dark);
            border-radius: 8px;
            background-color: #f8f8f8; /* Light background for iframe content */
            min-height: 300px;
        }
        .editor-actions {
            padding: 1rem 1.5rem;
            background-color: #1a1a1a;
            border-top: 1px solid var(--border-color-dark);
            gap: 1rem;
        }
        .editor-actions button {
            margin-top: 0; /* Override default margin-top from .form-action-button */
            padding: 0.7rem 1.2rem;
            font-size: 0.9rem;
        }

        /* Settings Tab Navigation */
        .settings-tab-btn {
            padding: 0.75rem 1.25rem;
            background-color: transparent;
            border: none;
            color: var(--text-color-light);
            font-weight: 500;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.2s ease;
        }
        body.light-mode .settings-tab-btn {
            color: var(--text-color-dark);
        }
        .settings-tab-btn:hover {
            color: var(--primary-color);
            border-color: rgba(0, 113, 227, 0.5);
        }
        .settings-tab-btn.active {
            color: var(--primary-color);
            border-color: var(--primary-color);
            font-weight: 600;
        }

        /* Company Selection Card for Settings */
        .company-select-card {
            background-color: #2a2a2e; /* Darker grey background */
            border: 1px solid #3a3a3e; /* Dark border */
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        body.light-mode .company-select-card {
            background-color: #f0f0f0; /* Lighter background in light mode */
            border-color: #d1d1d1;
        }
        .company-select-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        .company-details-section {
            background-color: #2a2a2e;
            border: 1px solid #3a3a3e;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            margin-top: 2.5rem;
        }
        body.light-mode .company-details-section {
            background-color: #fcfcfc;
            border-color: #e8e8ed;
        }

        /* Responsive adjustments */
        @media (min-width: 768px) {
            .editor-content-area {
                flex-direction: row;
            }
            .code-editor, .preview-area {
                border-right: 1px solid var(--border-color-dark); /* Separator in desktop view */
            }
            .preview-area {
                border-right: none; /* No right border on last item */
            }
        }
        @media (max-width: 767px) {
            .editor-content-area {
                flex-direction: column;
            }
            .code-editor, .preview-area {
                border-bottom: 1px solid var(--border-color-dark);
            }
            .preview-area {
                border-bottom: none;
            }
            .editor-actions {
                flex-direction: column;
            }
            .btn {
                width: 100%;
            }
        }


        /* Responsive Mobile Layout */
        @media (max-width: 767px) {
            body {
                flex-direction: column;
            }
            .sidebar {
                width: 100%;
                height: auto;
                padding: 1rem;
                border-right: none;
                border-bottom: 1px solid var(--border-color-dark);
                flex-direction: row; /* Horizontal layout for mobile nav */
                justify-content: space-around;
                flex-wrap: wrap; /* Allow nav items to wrap */
                position: sticky; /* Keep sidebar visible on scroll */
                top: 0;
                z-index: 40; /* Ensure it's above main content when scrolling */
            }
            .sidebar-header {
                width: 100%;
                margin-bottom: 1rem;
                display: flex; /* Make it a flex container to center logo */
                justify-content: center; /* Center logo horizontally */
                align-items: center;
                height: auto; /* Allow height to adjust */
            }
            .sidebar-header .theme-toggle {
                position: relative; /* Adjust position for mobile, remove absolute positioning */
                top: auto;
                right: auto;
                margin-left: 1rem; /* Add some spacing */
            }
            .sidebar-header .logo-text {
                font-size: 1.5rem; /* Adjust font size for mobile */
                letter-spacing: -0.01em;
            }
            .sidebar-header .logo-text span {
                font-size: 0.8em; /* Keep relative size */
            }
            .nav-list {
                display: flex;
                flex-wrap: wrap;
                justify-content: center;
                width: 100%;
            }
            .nav-list a {
                margin: 0.2rem 0.3rem; /* Tighter spacing for mobile nav items */
                padding: 0.5rem 0.6rem;
                font-size: 0.75rem; /* Smaller font size */
                gap: 0.5rem; /* Smaller gap for icon/text */
                flex-grow: 1; /* Allow items to stretch to fill space */
                justify-content: center; /* Center text within small buttons */
            }
            .nav-list a .nav-icon {
                font-size: 0.9rem; /* Smaller icon on mobile */
                margin-right: 0.2rem;
            }

            .main-content {
                padding: 1rem; /* Reduced padding for main content */
            }
            .panel {
                padding: 1.5rem; /* Reduced panel padding */
                margin-bottom: 1.5rem;
            }
            .panel h3 { font-size: 1.5rem; margin-bottom: 1rem;}
            .panel h4 { font-size: 1.2rem; margin-bottom: 0.8rem;}
            .metric-card p { font-size: 2rem; }
            .project-grid {
                grid-template-columns: 1fr; /* Stack projects on mobile */
                gap: 1rem;
            }
            .project-actions button {
                padding: 0.5rem 0.8rem;
                font-size: 0.8rem;
                margin-right: 0.3rem;
                margin-top: 0.5rem;
            }
            .form-control {
                margin-bottom: 1rem;
            }
            .form-control input, .form-control select, .form-control textarea {
                padding: 0.6rem;
                font-size: 0.9rem;
            }
            .form-action-button {
                padding: 0.7rem 1.2rem;
                font-size: 0.9rem;
            }
            .chart-container {
                height: 250px; /* Shorter charts on mobile */
            }
            .api-key-table th, .api-key-table td {
                padding: 0.6rem;
                font-size: 0.8rem;
            }
            .api-key-value {
                font-size: 0.7rem;
            }
            .security-note {
                padding: 0.8rem;
                font-size: 0.8rem;
            }
        }
    </style>
</head>
<body>
    <aside class="sidebar">
        <div class="sidebar-header">
            <h2 class="logo-text">Fruitful™ | <span>MineNest™</span></h2>
            <button id="themeToggle" class="theme-toggle" aria-label="Toggle theme">
                <i class="fas fa-sun"></i> </button>
        </div>
        <nav class="nav-list">
            <a href="#dashboard" class="active" data-view="dashboard">
                <i class="fas fa-home nav-icon"></i> Dashboard
            </a>
            <a href="#projects" data-view="projects">
                <i class="fas fa-project-diagram nav-icon"></i> Projects
            </a>
            <a href="#new-project" data-view="new-project">
                <i class="fas fa-plus-circle nav-icon"></i> New Project
            </a>
            <a href="#scroll-builder" data-view="scroll-builder">
                <i class="fas fa-tools nav-icon"></i> Content Builder
            </a>
            <a href="#ecosystem-map" data-view="ecosystem-map">
                <i class="fas fa-sitemap nav-icon"></i> Ecosystem Map
            </a>
            <a href="#global-checkout" data-view="global-checkout">
                <i class="fas fa-shopping-cart nav-icon"></i> Global Payment
            </a>
            <a href="#templates" data-view="templates">
                <i class="fas fa-palette nav-icon"></i> Templates
            </a>
            <a href="#licenses" data-view="licenses">
                <i class="fas fa-file-contract nav-icon"></i> My Licenses
            </a>
            <a href="#analytics" data-view="analytics">
                <i class="fas fa-chart-line nav-icon"></i> Analytics
            </a>
            <a href="#api-keys" data-view="api-keys">
                <i class="fas fa-key nav-icon"></i> API Keys
            </a>
            <a href="#settings" data-view="settings">
                <i class="fas fa-cog nav-icon"></i> Settings
            </a>
            <a href="#login" data-view="login">
                <i class="fas fa-sign-in-alt nav-icon"></i> Sign In
            </a>
            <a href="#signup" data-view="signup">
                <i class="fas fa-user-plus nav-icon"></i> Sign Up
            </a>
        </nav>
    </aside>

    <main class="main-content">
        <section id="dashboard-view" class="view">
            <div class="panel">
                <h3>Welcome Back, Mining Operations Lead!</h3>
                <p class="mb-4">Your MineNest™ portal provides comprehensive tools for managing, optimizing, and securing your mining and resource operations across the Fruitful Global Treaty Grid.</p>
                <button class="form-action-button" onclick="showView('new-project')">
                    <i class="fas fa-plus-circle mr-2"></i> Start New Mining Project
                </button>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
                <div class="metric-card">
                    <h4>Total Active Mine Sites</h4>
                    <p id="totalProjectsCount">0</p>
                </div>
                <div class="metric-card">
                    <h4>Active Drill Rigs</h4>
                    <p id="liveScrollsCount">0</p>
                </div>
                <div class="metric-card">
                    <h4>Monthly Ore Yield (Tonnes)</h4>
                    <p id="monthlyRoyalties">0</p>
                </div>
            </div>

            <div class="panel">
                <h3>Operational Health Overview</h3>
                <div class="chart-container">
                    <canvas id="systemHealthChart"></canvas>
                </div>
            </div>
            
            <div class="panel">
                <h3>MineNest™ Core Protocol Snapshot</h3>
                <p>MineNest™ ensures secure, real-time data flows for the Mining & Resources industry.</p>
                <h4>Key Features:</h4>
                <ul>
                    <li>Real-time Metrics Overview for immediate insights.</li>
                    <li>VaultTrace™ Ledger Entries for secure and transparent logging.</li>
                    <li>Integrated Compliance via VaultLink™ for mining-specific regulations.</li>
                    <li>Scalable Node Expansion for adapting to fluctuating demands.</li>
                    <li>Predictive Analytics for proactive decision-making.</li>
                </ul>
                <a href="https://faa.zone/sectors/mining/index.html" target="_blank" class="form-action-button">Go to FAA™ Mining & Resources Public Page →</a>
            </div>
        </section>

        <section id="projects-view" class="view view-hidden">
            <div class="panel">
                <h3>Your Mining Projects & Operations</h3>
                <div class="flex flex-wrap items-center gap-4 mb-4">
                    <input type="text" id="projectSearch" placeholder="Search projects..." class="flex-grow p-2 rounded-md bg-gray-700 border border-gray-600 text-white">
                    <select id="projectFilterStatus" class="p-2 rounded-md bg-gray-700 border border-gray-600 text-white">
                        <option value="all">All Statuses</option>
                        <option value="live">Active</option>
                        <option value="pending">Exploration</option>
                        <option value="draft">Planned</option>
                        <option value="error">Maintenance</option>
                    </select>
                </div>
                <div id="projectsList" class="project-grid">
                    </div>
                <div class="text-center mt-6">
                    <button id="loadMoreProjects" class="form-action-button"><i class="fas fa-sync-alt mr-2"></i> Load More Projects</button>
                </div>
            </div>
        </section>

        <section id="new-project-view" class="view view-hidden">
            <div class="panel">
                <h3><i class="fas fa-plus-circle mr-2"></i> Initiate a New Mining Project</h3>
                <form id="newProjectForm">
                    <div class="form-control">
                        <label for="projectName">Project Name</label>
                        <input type="text" id="projectName" name="projectName" placeholder="e.g. Deep Earth Exploration Alpha Site" required>
                    </div>

                    <div class="form-control">
                        <label for="template">Choose Template</label>
                        <select id="template" name="template" required>
                            <option value="">Loading templates...</option>
                        </select>
                    </div>

                    <div class="form-control">
                        <label for="description">Project Description</label>
                        <div class="flex items-center space-x-2">
                            <textarea id="description" name="description" rows="5" class="flex-grow" placeholder="Describe the scope, objectives, and resources for this mining project..."></textarea>
                            <button type="button" id="generateDescriptionBtn" class="form-action-button text-xs px-3 py-2">
                                <i class="fas fa-magic"></i> ✨ AI Generate Description
                            </button>
                        </div>
                        <p id="descriptionStatus" class="text-xs text-gray-400 mt-1"></p>
                    </div>

                    <div class="form-control">
                        <label for="projectConcept">High-Level Project Concept</label>
                        <div class="flex items-center space-x-2">
                            <input type="text" id="projectConcept" placeholder="e.g., Autonomous drilling rig deployment">
                            <button type="button" id="generateProjectIdeaBtn" class="form-action-button text-xs px-3 py-2">
                                ✨ AI Project Idea
                            </button>
                        </div>
                        <p id="projectIdeaStatus" class="text-xs text-gray-400 mt-1"></p>
                    </div>

                    <div class="form-control">
                        <label for="region">Operational Region</label>
                        <select id="region" name="region">
                            <option value="global">Global Deployment</option>
                            <option value="local">Local Site (Specific Geo-region)</option>
                            <option value="exploration">Exploration Phase</option>
                        </select>
                    </div>

                    <div class="form-control">
                        <label for="claim">Enable ClaimRoot™ Auto-License?</label>
                        <select id="claim" name="claim">
                            <option value="yes">Yes – License this operation</option>
                            <option value="no">No – Just save it</option>
                        </select>
                    </div>

                    <button type="submit" class="form-action-button">Create Project</button>
                    <p class="text-gray-500 text-sm mt-4">Projects will be saved in your MineNest workspace and can be synced to Fruitful Global upon deployment.</p>
                </form>
            </div>
        </section>

        <section id="scroll-builder-view" class="view view-hidden">
            <div class="panel">
                <h3><i class="fas fa-tools mr-2"></i> Content Builder — Deploy Your MineNest™ Content</h3>
                <form id="scrollBuilderForm">
                    <div class="form-control">
                        <label for="sbScrollName">Content Title</label>
                        <input type="text" id="sbScrollName" name="scrollName" placeholder="e.g. Real-time Ore Flow Dashboard">
                    </div>

                    <div class="form-control">
                        <label for="sbScrollType">Content Type</label>
                        <select id="sbScrollType" name="scrollType">
                            <option value="">Loading types...</option>
                        </select>
                    </div>

                    <div class="form-control">
                        <label for="htmlCode">HTML/Data Visualization Code</label>
                        <textarea id="htmlCode" name="htmlCode" rows="8" class="flex-grow" placeholder="Paste or write HTML for sensor data display, geological maps, etc..."></textarea>
                        <div class="flex flex-wrap items-center gap-2 mt-2">
                            <button type="button" id="refineHtmlBtn" class="form-action-button text-xs px-3 py-2">
                                ✨ Refine HTML
                            </button>
                            <button type="button" id="explainHtmlBtn" class="form-action-button secondary text-xs px-3 py-2">
                                ✨ Explain HTML
                            </button>
                            <button type="button" id="reviewHtmlBtn" class="form-action-button secondary text-xs px-3 py-2 bg-yellow-600 hover:bg-yellow-700">
                                ✨ Review HTML
                            </button>
                            <label for="uploadHtml" class="form-action-button text-xs px-3 py-2 cursor-pointer bg-gray-600 hover:bg-gray-700">
                                <i class="fas fa-upload mr-1"></i> Upload HTML
                                <input type="file" id="uploadHtml" accept=".html,.htm" class="hidden">
                            </label>
                            <input type="text" id="importHtmlUrl" placeholder="Import HTML from URL (e.g., GitHub raw)" class="flex-grow p-2 rounded-md bg-gray-700 border border-gray-600 text-white text-xs">
                            <button type="button" id="importHtmlUrlBtn" class="form-action-button text-xs px-3 py-2 bg-blue-600 hover:bg-blue-700">
                                <i class="fas fa-download mr-1"></i> Import
                            </button>
                        </div>
                        <p id="htmlRefineStatus" class="text-xs text-gray-400 mt-1"></p>
                        <div id="htmlExplanationOutput" class="w-full p-2 border border-gray-600 rounded-md bg-gray-700 text-white mt-2 hidden" style="white-space: pre-wrap;"></div>
                        <div id="htmlReviewOutput" class="w-full p-2 border border-gray-600 rounded-md bg-yellow-800 text-white mt-2 hidden" style="white-space: pre-wrap;"></div>
                    </div>

                    <div class="form-control">
                        <label for="cssCode">CSS Styling</label>
                        <textarea id="cssCode" name="cssCode" rows="6" class="flex-grow" placeholder="Add styling for your dashboards, maps, or data displays..."></textarea>
                        <div class="flex flex-wrap items-center gap-2 mt-2">
                            <button type="button" id="refineCssBtn" class="form-action-button text-xs px-3 py-2">
                                ✨ Refine CSS
                            </button>
                            <button type="button" id="explainCssBtn" class="form-action-button secondary text-xs px-3 py-2">
                                ✨ Explain CSS
                            </button>
                            <button type="button" id="reviewCssBtn" class="form-action-button secondary text-xs px-3 py-2 bg-yellow-600 hover:bg-yellow-700">
                                ✨ Review CSS
                            </button>
                            <label for="uploadCss" class="form-action-button text-xs px-3 py-2 cursor-pointer bg-gray-600 hover:bg-gray-700">
                                <i class="fas fa-upload mr-1"></i> Upload CSS
                                <input type="file" id="uploadCss" accept=".css" class="hidden">
                            </label>
                            <input type="text" id="importCssUrl" placeholder="Import CSS from URL (e.g., GitHub raw)" class="flex-grow p-2 rounded-md bg-gray-700 border border-gray-600 text-white text-xs">
                            <button type="button" id="importCssUrlBtn" class="form-action-button text-xs px-3 py-2 bg-blue-600 hover:bg-blue-700">
                                <i class="fas fa-download mr-1"></i> Import
                            </button>
                        </div>
                        <p id="cssRefineStatus" class="text-xs text-gray-400 mt-1"></p>
                        <div id="cssExplanationOutput" class="w-full p-2 border border-gray-600 rounded-md bg-gray-700 text-white mt-2 hidden" style="white-space: pre-wrap;"></div>
                        <div id="cssReviewOutput" class="w-full p-2 border border-gray-600 rounded-md bg-yellow-800 text-white mt-2 hidden" style="white-space: pre-wrap;"></div>
                    </div>

                    <div class="form-control">
                        <label for="jsCode">JavaScript (Optional)</label>
                        <textarea id="jsCode" name="jsCode" rows="5" class="flex-grow" placeholder="Optional scripts for real-time data feeds, map interactions, predictive models..."></textarea>
                        <div class="flex flex-wrap items-center gap-2 mt-2">
                            <button type="button" id="refineJsBtn" class="form-action-button text-xs px-3 py-2">
                                ✨ Refine JavaScript
                            </button>
                            <button type="button" id="explainJsBtn" class="form-action-button secondary text-xs px-3 py-2">
                                ✨ Explain JavaScript
                            </button>
                            <button type="button" id="reviewJsBtn" class="form-action-button secondary text-xs px-3 py-2 bg-yellow-600 hover:bg-yellow-700">
                                ✨ Review JavaScript
                            </button>
                            <label for="uploadJs" class="form-action-button text-xs px-3 py-2 cursor-pointer bg-gray-600 hover:bg-gray-700">
                                <i class="fas fa-upload mr-1"></i> Upload JS
                                <input type="file" id="uploadJs" accept=".js" class="hidden">
                            </label>
                            <input type="text" id="importJsUrl" placeholder="Import JS from URL (e.g., GitHub raw)" class="flex-grow p-2 rounded-md bg-gray-700 border border-gray-600 text-white text-xs">
                            <button type="button" id="importJsUrlBtn" class="form-action-button text-xs px-3 py-2 bg-blue-600 hover:bg-blue-700">
                                <i class="fas fa-download mr-1"></i> Import
                            </button>
                        </div>
                        <p id="jsRefineStatus" class="text-xs text-gray-400 mt-1"></p>
                        <div id="jsExplanationOutput" class="w-full p-2 border border-gray-600 rounded-md bg-gray-700 text-white mt-2 hidden" style="white-space: pre-wrap;"></div>
                        <div id="jsReviewOutput" class="w-full p-2 border border-gray-600 rounded-md bg-yellow-800 text-white mt-2 hidden" style="white-space: pre-wrap;"></div>
                    </div>

                    <div class="form-control">
                        <label for="scrollTopic">Content Topic (for AI Content Ideas)</label>
                        <div class="flex items-center space-x-2">
                            <input type="text" id="scrollTopic" placeholder="e.g., Geological Survey Reports, Equipment Maintenance Schedules">
                            <button type="button" id="generateContentIdeasBtn" class="form-action-button text-xs px-3 py-2">
                                ✨ Generate Ideas
                            </button>
                        </div>
                        <p id="contentIdeasStatus" class="text-xs text-gray-400 mt-1"></p>
                        <textarea id="contentIdeasOutput" rows="8" class="w-full p-2 border border-gray-600 rounded-md bg-gray-700 text-white mt-2" placeholder="Generated content ideas will appear here..." readonly></textarea>
                    </div>

                    <div class="form-control">
                        <label for="sbClaim">Content Licensing with ClaimRoot™?</label>
                        <select id="sbClaim" name="claim">
                            <option value="yes">Yes — Activate content claim</option>
                            <option value="no">No — Build only</option>
                        </select>
                    </div>

                    <button type="submit" class="form-action-button">Compile Content & Save</button>
                    <p class="text-gray-500 text-sm mt-4">Your content will be saved to your local MineNest workspace with optional auto-deploy to Fruitful Global.</p>
                </form>
            </div>
        </section>

        <section id="ecosystem-map-view" class="view view-hidden">
            <div class="panel">
                <h2 class="section-title text-center mb-12">Global Repository & Routing Structure</h2>
                <p class="section-intro mb-8">This section illustrates the precise, templated file path and repository structure for the entire FAA.Zone ecosystem. Click on a sector to expand its details and reveal the exact URLs. This structure guarantees consistency and automated deployment across all 7038+ digital assets.</p>
                
                <div id="sectorContainer" class="max-w-4xl mx-auto bg-gray-800 p-6 rounded-lg shadow-2xl text-left">
                    <h3 class="text-xl font-bold mb-4 text-yellow-400">Explore File Paths by Sector:</h3>
                    <div class="space-y-3">
                        </div>
                </div>

                <div class="panel mt-8">
                    <h2 class="section-title text-center mb-12">Global Footer Repository: The Legal Standard</h2>
                    <p class="section-intro mb-8">The global footer, including all mandatory legal and ecosystem links, is managed from a single, dedicated repository. This ensures strict consistency, legal compliance, and branding integrity across every single page, brand, and subnode within the FAA.Zone.</p>
                    
                    <div class="max-w-3xl mx-auto bg-gray-800 p-6 rounded-lg shadow-2xl text-left">
                        <h3 class="text-xl font-bold mb-4 text-yellow-400">Conceptual `footer-global-repo` Structure:</h3>
                        <div class="copy-square">
                            <button class="copy-button" onclick="copyToClipboard(this)">Copy</button>
                            <pre class="conversation-code-block">
/footer-global-repo/
├── src/
│   ├── components/
│   │   └── GlobalFooter.js  # Reusable footer component
│   └── styles/
│       └── footer.css       # Styling for the footer
├── public/
│   ├── privacy.html         # Content for /privacy route
│   ├── terms.html           # Content for /terms route
│   ├── contact.html         # Content for /contact route
│   ├── copyright.html       # Content for /copyright route
│   ├── developers.html      # Content for /developers route
│   ├── vaultmesh.html       # Content for /vaultmesh route
│   ├── fruitful.html        # Content for /fruitful route
│   ├── faa.zone.html        # Content for /faa.zone route
│   ├── about.html           # Content for /about route
│   └── accessibility.html   # Content for /accessibility route
└── package.json             # Build scripts for global deployment
                            </pre>
                        </div>
                        <p class="text-gray-400 text-sm">This repository is automatically integrated into every sector's build process, ensuring all sites adhere to the global footer mandate.</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- START: Consolidated Global Payment Section (Moved and Enhanced) -->
        <section id="global-checkout-view" class="view view-hidden">
            <div class="panel">
                <h2 class="section-title text-center mb-8">Global Payment & Checkout: Seamless Transactions</h2>
                <p class="section-intro mb-8">Fruitful Global provides a unified, secure, and automated payment and checkout solution. Integrated with **VaultPay™** for secure transactions and **ClaimRoot™** for automated licensing, this system ensures a frictionless experience for both customers and partners globally. No payment-related troubleshooting needed; the logic is transparent and self-validating.</p>

                <!-- Existing Simulated Checkout Flow (NOW HERE) -->
                <div class="max-w-2xl mx-auto bg-gray-800 p-8 rounded-lg shadow-2xl mb-8">
                    <h3 class="text-xl font-bold mb-6 text-yellow-400">MineNest™ Enterprise License Checkout (Simulated)</h3>
                    
                    <div id="checkout-step-1">
                        <h4 class="text-lg font-semibold mb-4 text-white flex items-center justify-center"><span class="step-indicator">1</span> Item Selection</h4>
                        <p class="text-gray-300 mb-4">Your selected item: **MineNest™ Enterprise License**</p>
                        <p class="text-gray-300 mb-4">Price: **$19,999.00 USD** (One-time license fee)</p>
                        <button class="checkout-button" onclick="showCheckoutStep(2)">Proceed to Checkout</button>
                    </div>

                    <div id="checkout-step-2" class="hidden">
                        <h4 class="text-lg font-semibold mb-4 text-white flex items-center justify-center"><span class="step-indicator">2</span> Payment Information</h4>
                        <p class="text-gray-300 mb-4">Enter your secure payment details for **VaultPay™** processing.</p>
                        <input type="text" id="cardNumber" placeholder="Card Number (e.g., 4111 XXXX XXXX 1111)" class="checkout-input mb-3">
                        <div class="grid grid-cols-2 gap-4 mb-4">
                            <input type="text" id="expiryDate" placeholder="MM/YY" class="checkout-input">
                            <input type="text" id="cvc" placeholder="CVC" class="checkout-input">
                        </div>
                        <button class="checkout-button w-full" onclick="processPayment()">Process Payment via VaultPay™</button>
                        <p id="paymentStatus" class="text-red-400 mt-2 text-sm hidden">Payment processing...</p>
                    </div>

                    <div id="checkout-step-3" class="hidden">
                        <h4 class="text-lg font-semibold mb-4 text-white flex items-center justify-center"><span class="step-indicator">3</span> Order Confirmation & Licensing</h4>
                        <p class="text-gray-300 mb-4">Your order is confirmed! Licensing is being secured via **ClaimRoot™**.</p>
                        <p id="orderStatus" class="text-green-400 mb-4">Status: **Processing ClaimRoot™ License...**</p>
                        <button class="checkout-button w-full" onclick="resetCheckout()">Complete & Return to Dashboard</button>
                    </div>
                </div>
                <!-- END: Existing Simulated Checkout Flow -->

                <!-- NEW: PayPal Checkout Integration -->
                <div class="max-w-2xl mx-auto bg-gray-800 p-8 rounded-lg shadow-2xl mt-8">
                    <h3 class="text-xl font-bold mb-6 text-yellow-400">Pay with PayPal (Real-time Simulation)</h3>
                    <p class="text-gray-300 mb-4">Secure your **MineNest™ Enterprise License** instantly using PayPal.</p>
                    <p class="text-gray-300 mb-6">Price: <strong class="text-white">$19,999.00 USD</strong></p>
                    <div id="paypal-button-container" class="flex justify-center">
                        <!-- PayPal buttons will render here -->
                    </div>
                    <p id="paypal-messages" class="text-center mt-4 text-sm text-yellow-400"></p>
                </div>
                <!-- END: PayPal Checkout Integration -->
            </div>
        </section>
        <!-- END: Consolidated Global Payment Section -->


        <section id="editor-workspace-view" class="view view-hidden">
            <div class="editor-container">
                <div class="editor-header">
                    <span id="currentProjectEditName">Content Editor</span>
                    <button class="text-white text-xl hover:text-gray-300" onclick="showView('projects')">
                        <i class="fas fa-times-circle"></i>
                    </button>
                </div>
                <div class="editor-content-area">
                    <div class="code-editor">
                        <h4 class="text-xl font-semibold mb-4 text-white">Edit HTML/CSS</h4>
                        <textarea id="editorHtmlCssCode" placeholder="Edit your Mining & Resources content code here..."></textarea>
                        <div class="flex flex-wrap items-center gap-2 mt-2">
                            <button type="button" id="editorRefineCodeBtn" class="form-action-button text-xs px-3 py-2">
                                ✨ Refine Code
                            </button>
                            <button type="button" id="editorExplainCodeBtn" class="form-action-button secondary text-xs px-3 py-2">
                                ✨ Explain Code
                            </button>
                            <button type="button" id="editorReviewCodeBtn" class="form-action-button secondary text-xs px-3 py-2 bg-yellow-600 hover:bg-yellow-700">
                                ✨ Review Code
                            </button>
                        </div>
                        <p id="editorHtmlCssStatus" class="text-xs text-gray-400 mt-1 hidden"></p>
                        <div id="editorHtmlCssExplanationOutput" class="w-full p-2 border border-gray-600 rounded-md bg-gray-700 text-white mt-2 hidden" style="white-space: pre-wrap;"></div>
                        <div id="editorHtmlCssReviewOutput" class="w-full p-2 border border-gray-600 rounded-md bg-yellow-800 text-white mt-2 hidden" style="white-space: pre-wrap;"></div>

                        <h5 class="text-lg font-semibold mt-6 mb-2 text-white">AI Content Generation</h5>
                        <div class="form-control">
                            <label for="editorSectionTopicInput" class="text-white text-sm mb-1">Content Segment Topic</label>
                            <input type="text" id="editorSectionTopicInput" placeholder="e.g., Ore Processing Efficiency, Safety Protocol Updates" class="w-full p-2 rounded-md bg-gray-700 border border-gray-600 text-white text-sm">
                        </div>
                        <div class="flex flex-wrap items-center gap-2 mt-2">
                            <button type="button" id="editorGenerateHeadlineBtn" class="form-action-button text-xs px-3 py-2">
                                ✨ Generate Headline
                            </button>
                            <button type="button" id="editorGenerateCTABtn" class="form-action-button text-xs px-3 py-2">
                                ✨ Generate CTA
                            </button>
                            <button type="button" id="editorGenerateSectionContentBtn" class="form-action-button text-xs px-3 py-2">
                                ✨ Generate Section Content
                            </button>
                        </div>
                        <div class="form-control mt-4">
                            <label for="editorRephraseTextInput" class="text-white text-sm mb-1">Rephrase/Improve Text</label>
                            <textarea id="editorRephraseTextInput" rows="3" placeholder="Enter text to rephrase or improve..." class="w-full p-2 rounded-md bg-gray-700 border border-gray-600 text-white text-sm"></textarea>
                        </div>
                        <div class="flex flex-wrap items-center gap-2 mt-2">
                            <button type="button" id="editorRephraseTextBtn" class="form-action-button text-xs px-3 py-2">
                                ✨ Rephrase/Improve
                            </button>
                        </div>
                        <p id="editorContentGenStatus" class="text-xs text-gray-400 mt-1 hidden"></p>
                        <div id="editorGeneratedContentOutput" class="w-full p-2 border border-gray-600 rounded-md bg-gray-700 text-white mt-2 hidden" style="white-space: pre-wrap;"></div>
                    </div>
                    <div class="preview-area">
                        <h4 class="text-xl font-semibold mb-4 text-white">Live Preview</h4>
                        <iframe id="editorLivePreviewFrame" title="Live Preview"></iframe>
                    </div>
                </div>
                <div class="editor-actions flex justify-center w-full"> <button class="form-action-button secondary" onclick="updateEditorPreview()">Update Preview</button>
                    <button class="form-action-button" onclick="showCustomModal('Save Project', 'Project saved! (Simulation)')">Save Project</button>
                    <button class="form-action-button" onclick="showCustomModal('Deploy Project', 'Project deployed! (Simulation)')">Deploy Project</button>
                </div>
            </div>
        </section>


        <section id="templates-view" class="view view-hidden">
            <div class="panel">
                <h3><i class="fas fa-palette mr-2"></i> Select a Template</h3>
                <div id="templatesGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    </div>
            </div>
        </section>

        <section id="licenses-view" class="view view-hidden">
            <div class="panel">
                <h3><i class="fas fa-file-contract mr-2"></i> My Licensed Mining Operations</h3>
                <p class="mb-4 text-gray-400">View and manage all your deployed and licensed mining operations and content within the Fruitful Global network.</p>
                <div id="licensesList" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    </div>
            </div>

            <div class="panel">
                <h3><i class="fas fa-handshake mr-2"></i> Royalty License Agreements</h3>
                <p class="mb-4 text-gray-400">Review and sign your royalty agreements with Fruitful Global via SecureSign™.</p>
                <div id="royaltyAgreementsList" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    </div>
            </div>
        </section>

        <section id="analytics-view" class="view view-hidden">
            <div class="panel">
                <h3><i class="fas fa-chart-line mr-2"></i> Operational Analytics</h3>
                <p class="mb-4 text-gray-400">Insights into your deployed mining assets and overall platform engagement.</p>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                    <div class="chart-container">
                        <canvas id="deploymentTrendsChart"></canvas>
                    </div>
                    <div class="chart-container">
                        <canvas id="royaltyDistributionChart"></canvas>
                    </div>
                </div>

                <div class="panel">
                    <h4>Equipment Performance Metrics</h4>
                    <div class="chart-container">
                        <canvas id="userActivityChart"></canvas>
                    </div>
                </div>
            </div>
        </section>

        <section id="api-keys-view" class="view view-hidden">
            <div class="panel">
                <h3><i class="fas fa-key mr-2"></i> Consolidated API Key Index (Fruitful Global)</h3>
                <p class="mb-4 text-gray-400">This document provides a comprehensive list of all API keys and credentials identified across your provided canvases and chat interactions. It explicitly lists every canvas where each key was embedded or mentioned.</p>

                <div class="security-note">
                    <strong>Important Security Note:</strong> Directly embedding API keys and sensitive credentials in client-side HTML or JavaScript is generally not recommended for production environments. This exposes your keys, making them vulnerable to misuse. For deployed applications, it is strongly advised to use a secure backend server to proxy your API requests and manage these keys via environment variables or a dedicated secrets management system.
                </div>

                <table class="api-key-table">
                    <thead>
                        <tr>
                            <th>API/Service</th>
                            <th>Key/Credential Details</th>
                            <th>Embedded Locations</th>
                        </tr>
                    </thead>
                    <tbody id="apiKeysTableBody">
                        </tbody>
                </table>
            </div>
        </section>

        <section id="settings-view" class="view view-hidden">
            <div class="panel">
                <h3><i class="fas fa-cog mr-2"></i> My Settings</h3>

                <div class="flex border-b border-gray-700 mb-6">
                    <button class="settings-tab-btn active" data-settings-tab="profile">Profile</button>
                    <button class="settings-tab-btn" data-settings-tab="preferences">Operational Preferences</button>
                    <button class="settings-tab-btn" data-settings-tab="security">Security</button>
                    <button class="settings-tab-btn" data-settings-tab="domains">Domain & Cloud Services</button>
                </div>

                <div id="settings-profile" class="settings-sub-view">
                    <section class="panel bg-gray-900 border border-gray-700">
                        <h4>Profile</h4>
                        <div class="form-control">
                            <label for="displayName">Display Name</label>
                            <input type="text" id="displayName" value="MineOpsLead001">
                        </div>

                        <div class="form-control">
                            <label for="email">Email</label>
                            <input type="email" id="email" value="mining.lead@example.com">
                        </div>

                        <button class="form-action-button" onclick="showCustomModal('Profile Updated!', 'Your display name and email have been saved.')">Update Profile</button>
                    </section>
                </div>

                <div id="settings-preferences" class="settings-sub-view hidden">
                    <section class="panel bg-gray-900 border border-gray-700">
                        <h4>Operational Preferences</h4>
                        <div class="form-control">
                            <label for="defaultRegion">Default Operational Region</label>
                            <select id="defaultRegion">
                                <option value="global">Global Deployment</option>
                                <option value="local">Local Site (Specific Geo-region)</option>
                                <option value="exploration">Exploration Phase</option>
                            </select>
                        </div>

                        <div class="form-control">
                            <label for="autoClaimSetting">Auto-Enable ClaimRoot™ on Deployment?</label>
                            <select id="autoClaimSetting">
                                <option value="yes">Yes</option>
                                <option value="no">No</option>
                            </select>
                        </div>

                        <button class="form-action-button" onclick="showCustomModal('Preferences Saved!', 'Your operational preferences have been updated.')">Save Preferences</button>
                    </section>
                </div>

                <div id="settings-security" class="settings-sub-view hidden">
                    <section class="panel bg-gray-900 border border-gray-700">
                        <h4>Security</h4>
                        <div class="form-control">
                            <label for="password">Change Password</label>
                            <input type="password" id="password" placeholder="New Password">
                        </div>

                        <div class="form-control">
                            <label for="confirmPassword">Confirm Password</label>
                            <input type="password" id="confirmPassword" placeholder="Confirm Password">
                        </div>

                        <button class="form-action-button" onclick="showCustomModal('Password Updated!', 'Your password has been changed securely.')">Update Password</button>
                    </section>
                </div>

                <div id="settings-domains" class="settings-sub-view hidden">
                    <section class="panel bg-gray-900 border border-gray-700 mb-6">
                        <h4>DNS Zone Management (Cloudflare Integrated)</h4>
                        <p class="text-gray-400 text-sm mb-4">Manage your domain's DNS records (A, CNAME, MX, TXT) with direct Cloudflare integration.</p>
                        <table class="api-key-table mb-4">
                            <thead>
                                <tr>
                                    <th>Type</th>
                                    <th>Name</th>
                                    <th>Value</th>
                                    <th>TTL</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="dnsRecordsTableBody">
                                </tbody>
                        </table>
                        <div class="flex flex-wrap items-center gap-2">
                            <input type="text" id="dnsRecordTypeInput" placeholder="DNS Type (e.g., A, CNAME, MX)" class="flex-grow p-2 rounded-md bg-gray-700 border border-gray-600 text-white text-xs max-w-[200px]">
                            <button class="form-action-button text-sm px-3 py-2 bg-purple-600 hover:bg-purple-700" id="explainDnsBtn">
                                ✨ Explain DNS Type
                            </button>
                            <button class="form-action-button text-sm px-3 py-2" onclick="showCustomModal('Add DNS Record', 'Add new DNS record functionality coming soon!')">
                                <i class="fas fa-plus mr-1"></i> Add Record
                            </button>
                        </div>
                        <p id="dnsExplainStatus" class="text-xs text-gray-400 mt-1 hidden"></p>
                        <div id="dnsExplanationOutput" class="w-full p-2 border border-gray-600 rounded-md bg-gray-700 text-white mt-2 hidden" style="white-space: pre-wrap;"></div>
                    </section>

                    <section class="panel bg-gray-900 border border-gray-700 mb-6">
                        <h4>Domain Management (Vercel Integrated for Silent Deployments)</h4>
                        <p class="text-gray-400 text-sm mb-4">Manage your primary domains and add-on domains. Deployed silently via Vercel integration.</p>
                        <ul id="domainList" class="list-disc list-inside text-gray-200 mb-4">
                            <li><i class="fas fa-check-circle text-green-500 mr-2"></i> minenest.faa.zone (Primary)</li>
                            <li><i class="fas fa-check-circle text-green-500 mr-2"></i> drillcorex.minenest.faa.zone (Subdomain)</li>
                            </ul>
                        <div class="flex flex-wrap items-center gap-2">
                            <input type="text" id="newDomainName" placeholder="Add New Domain (e.g., newmine.com)" class="flex-grow p-2 rounded-md bg-gray-700 border border-gray-600 text-white text-sm">
                            <button class="form-action-button text-sm px-3 py-2" onclick="showCustomModal('Add Domain', 'Adding domain functionality coming soon!')">
                                <i class="fas fa-plus mr-1"></i> Add Domain
                            </button>
                        </div>
                        <div class="flex flex-wrap items-center gap-2 mt-2">
                            <input type="text" id="newAddonDomainName" placeholder="Add Add-on Domain (e.g., resource.newmine.com)" class="flex-grow p-2 rounded-md bg-gray-700 border border-gray-600 text-white text-sm">
                            <select id="addonDomainTarget" class="p-2 rounded-md bg-gray-700 border border-gray-600 text-white text-sm">
                                <option value="">Select Primary Domain</option>
                                <option value="minenest.faa.zone">minenest.faa.zone</option>
                            </select>
                            <button class="form-action-button text-sm px-3 py-2" onclick="showCustomModal('Add Add-on Domain', 'Adding add-on domain functionality coming soon!')">
                                <i class="fas fa-plus mr-1"></i> Add Add-on
                            </button>
                        </div>
                        <button class="form-action-button mt-4 bg-blue-600 hover:bg-blue-700" onclick="showCustomModal('Silent Deploy Initiated', 'Initiating silent deployment across Cloudflare and Vercel...')">
                            <i class="fas fa-cloud-upload-alt mr-1"></i> Deploy in Silence
                        </button>
                    </section>

                    <section class="panel bg-gray-900 border border-gray-700">
                        <h4>Email Accounts (Powered by Zoho Mail)</h4>
                        <p class="text-gray-400 text-sm mb-4">Create and manage email accounts for your domains.</p>
                        <table class="api-key-table mb-4">
                            <thead>
                                <tr>
                                    <th>Email Address</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="emailAccountsTableBody">
                                </tbody>
                        </table>
                        <div class="flex flex-wrap items-center gap-2">
                            <input type="text" id="newEmailPrefix" placeholder="New email (e.g., operations)" class="w-1/3 p-2 rounded-md bg-gray-700 border border-gray-600 text-white text-sm">
                            <span class="text-gray-200">@</span>
                            <input type="text" id="newEmailDomain" placeholder="yourdomain.com" value="minenest.faa.zone" class="w-1/3 p-2 rounded-md bg-gray-700 border border-gray-600 text-white text-sm">
                            <button class="form-action-button text-sm px-3 py-2" id="createEmailBtn">
                                <i class="fas fa-plus mr-1"></i> Create Email
                            </button>
                        </div>
                        <p id="emailDraftStatus" class="text-xs text-gray-400 mt-1 hidden"></p>
                    </section>

                    <section class="panel bg-gray-900 border border-gray-700 mt-8">
                        <h4 class="text-yellow-400 mb-4">Company Infrastructure Setup & Details</h4>
                        <p class="text-gray-300 mb-4">Access the comprehensive setup details for any company. Select a company below to reveal its granular configurations. **No troubleshooting or helpline needed**.</p>
                        
                        <div id="settingsCompanySelectionGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-8">
                                </div>

                        <div id="settingsCompanyDetailsOutput" class="company-details-section hidden">
                                </div>
                    </section>

                </div>

                <p class="text-gray-500 text-sm mt-4">All changes are synced to your Fruitful Global vault and stored with encrypted ClaimRoot credentials.</p>
            </div>
        </section>

        <section id="login-view" class="view view-hidden">
            <div class="panel">
                <h3><i class="fas fa-sign-in-alt mr-2"></i> Sign In to MineNest™</h3>
                <form id="loginForm">
                    <div class="form-control">
                        <label for="loginEmail">Email</label>
                        <input type="email" id="loginEmail" placeholder="your@email.com" value="mining.lead@example.com" required>
                    </div>
                    <div class="form-control">
                        <label for="loginPassword">Password</label>
                        <input type="password" id="loginPassword" placeholder="••••••••" value="password123" required>
                    </div>
                    <button type="submit" class="form-action-button">Login</button>
                    <p class="text-gray-500 text-sm mt-4">Don't have an account? <a href="#signup" class="text-blue-500 hover:underline" onclick="showView('signup')">Sign Up</a></p>
                </form>
            </div>
        </section>

        <section id="signup-view" class="view view-hidden">
            <div class="panel">
                <h3><i class="fas fa-user-plus mr-2"></i> Join MineNest™</h3>
                <form id="signupForm">
                    <div class="form-control">
                        <label for="signupName">Display Name</label>
                        <input type="text" id="signupName" placeholder="Your Operations Name" required>
                    </div>
                    <div class="form-control">
                        <label for="signupEmail">Email</label>
                        <input type="email" id="signupEmail" placeholder="your@email.com" required>
                    </div>
                    <div class="form-control">
                        <label for="signupPassword">Password</label>
                        <input type="password" id="signupPassword" placeholder="••••••••" required>
                    </div>
                    <div class="form-control">
                        <label for="signupConfirmPassword">Confirm Password</label>
                        <input type="password" id="signupConfirmPassword" placeholder="••••••••" required>
                    </div>
                    <button type="submit" class="form-action-button">Sign Up</button>
                    <p class="text-gray-500 text-sm mt-4">Already have an account? <a href="#login" class="text-blue-500 hover:underline" onclick="showView('login')">Sign In</a></p>
                </form>
            </div>
        </section>
    </main>

    <div id="templatePreviewModal" class="custom-modal-overlay">
        <div class="custom-modal-content max-w-4xl w-full h-auto" style="padding: 0; text-align: left;">
            <div class="template-preview-header">
                <h3 id="templatePreviewTitle"></h3>
                <button class="close-preview-btn" onclick="hideTemplatePreviewModal()"><i class="fas fa-times"></i></button>
            </div>
            <div class="template-preview-body">
                <iframe id="templatePreviewFrame" class="template-preview-frame" sandbox="allow-scripts allow-same-origin"></iframe>
                <p id="templatePreviewDescription" class="text-gray-400 text-sm mt-2"></p>
                <div class="template-preview-actions">
                    <button class="btn-primary" id="useTemplateNewProjectBtn"><i class="fas fa-plus-circle mr-2"></i> Use in New Project</button>
                    <button class="btn-secondary" id="useTemplateScrollBuilderBtn"><i class="fas fa-tools mr-2"></i> Use in Content Builder</button>
                </div>
            </div>
        </div>
    </div>

    <div id="simplifyAgreementModal" class="custom-modal-overlay view-hidden">
        <div class="custom-modal-content max-w-xl w-full h-auto">
            <div class="template-preview-header">
                <h3 id="simplifyAgreementTitle">Simplified Agreement</h3>
                <button class="close-preview-btn" onclick="hideSimplifyAgreementModal()"><i class="fas fa-times"></i></button>
            </div>
            <div class="template-preview-body">
                <p id="simplifiedAgreementText" class="text-gray-700 text-left whitespace-pre-wrap leading-relaxed"></p>
                <div class="template-preview-actions">
                    <button class="btn-secondary" onclick="hideSimplifyAgreementModal()">Close</button>
                </div>
            </div>
        </div>
    </div>

    <div id="projectIdeaModal" class="custom-modal-overlay view-hidden">
        <div class="custom-modal-content max-w-xl w-full h-auto">
            <div class="template-preview-header">
                <h3 id="projectIdeaModalTitle">AI Project Idea</h3>
                <button class="close-preview-btn" onclick="hideProjectIdeaModal()"><i class="fas fa-times"></i></button>
            </div>
            <div class="template-preview-body text-left">
                <p class="text-gray-400 text-sm mb-2">Review the AI-generated idea below:</p>
                <div class="bg-gray-800 p-4 rounded-md border border-gray-700">
                    <p class="text-gray-200 mb-2"><strong>Project Name:</strong> <span id="ideaProjectName"></span></p>
                    <p class="text-gray-200 mb-2"><strong>Description:</strong> <span id="ideaProjectDescription"></span></p>
                    <p class="text-gray-200"><strong>Suggested Template:</strong> <span id="ideaSuggestedTemplate"></span></p>
                </div>
                <div class="template-preview-actions">
                    <button class="btn-primary" id="applyProjectIdeaBtn"><i class="fas fa-check-circle mr-2"></i> Apply Idea to Form</button>
                    <button class="btn-secondary" onclick="hideProjectIdeaModal()">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <div id="projectSummaryModal" class="custom-modal-overlay view-hidden">
        <div class="custom-modal-content max-w-xl w-full h-auto">
            <div class="template-preview-header">
                <h3 id="projectSummaryTitle">Project Summary</h3>
                <button class="close-preview-btn" onclick="hideProjectSummaryModal()"><i class="fas fa-times"></i></button>
            </div>
            <div class="template-preview-body">
                <p id="projectSummaryText" class="text-gray-700 text-left whitespace-pre-wrap leading-relaxed"></p>
                <div class="template-preview-actions">
                    <button class="btn-secondary" onclick="hideProjectSummaryModal()">Close</button>
                </div>
            </div>
        </div>
    </div>

    <div id="emailDraftModal" class="custom-modal-overlay view-hidden">
        <div class="custom-modal-content max-w-xl w-full h-auto">
            <div class="template-preview-header">
                <h3 id="emailDraftTitle">Draft Email</h3>
                <button class="close-preview-btn" onclick="hideEmailDraftModal()"><i class="fas fa-times"></i></button>
            </div>
            <div class="template-preview-body text-left">
                <p class="text-gray-400 text-sm mb-2">To: <span id="emailDraftTo"></span></p>
                <div class="form-control">
                    <label for="emailPurposeInput" class="text-white text-sm mb-1">Purpose of Email</label>
                    <input type="text" id="emailPurposeInput" placeholder="e.g., Welcome new user, Support query, Marketing announcement" class="w-full p-2 rounded-md bg-gray-700 border border-gray-600 text-white text-sm">
                </div>
                <button type="button" id="generateEmailDraftBtn" class="form-action-button text-xs px-3 py-2">
                    ✨ Generate Draft
                </button>
                <p id="emailDraftStatus" class="text-xs text-gray-400 mt-1 hidden"></p>
                <textarea id="generatedEmailDraftOutput" rows="10" class="w-full p-2 border border-gray-600 rounded-md bg-gray-700 text-white mt-2" placeholder="Your AI-generated email draft will appear here..." readonly></textarea>
                <div class="template-preview-actions">
                    <button class="btn-primary" onclick="document.execCommand('copy'); showCustomModal('Email Copied', 'Email draft copied to clipboard!', true);">Copy to Clipboard</button>
                    <button class="btn-secondary" onclick="hideEmailDraftModal()">Close</button>
                </div>
            </div>
        </div>
    </div>


    <div id="customModal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-gray-800 text-white p-6 rounded-lg shadow-xl text-center max-w-sm">
            <p id="customModalMessage"></p>
        </div>
    </div>

    <script>
        // Define mining brands and subnodes from your provided array
        const miningBrandsRaw = [
            'MineNest', 'DrillCoreX', 'OreSync', 'VaultRock', 'ClaimMine',
            'TrackShaft', 'PulseMine', 'CoreBeam', 'DigEcho', 'RockPath',
            'YieldDrill', 'MineProof', 'OreLine', 'DrillLink', 'VaultTunnel',
            'GeoGrid', 'SeamSync', 'ClaimOre', 'PulseBlast', 'OreEcho',
            'DeepCrate', 'RockLogic', 'CoreDrill', 'MineCast', 'DrillMark',
            'SignalOre', 'YieldTrack', 'VaultSeam', 'ShaftDrop', 'GeoNode'
        ];

        const miningSubNodesRaw = [
            ['NestTrack', 'VaultShaft', 'QRMine', 'ClaimGrid'],
            ['CoreDrop', 'PulsePath', 'OreTrace', 'DrillYield'],
            ['SyncRock', 'VaultEcho', 'QRDrill', 'ClaimTag'],
            ['RockBeam', 'MineLoop', 'SignalTrace', 'QRClaim'],
            ['ClaimOre', 'VaultPath', 'OrePing', 'MineSignal'],
            ['ShaftMesh', 'DropMine', 'TrackSeam', 'QRTrack'],
            ['PulseCrate', 'MineEcho', 'YieldDrill', 'GridTag'],
            ['BeamPath', 'ClaimRock', 'VaultLoop', 'SeamDrop'],
            ['EchoMine', 'RockPing', 'VaultTrace', 'ClaimBeam'],
            ['PathDrop', 'GridMine', 'QRNode', 'YieldOre'],
            ['DrillGrid', 'ClaimYield', 'SyncTunnel', 'OreEcho'],
            ['ProofMine', 'SeamCast', 'VaultGrid', 'DropCrate'],
            ['OreLineX', 'VaultDrill', 'MineForm', 'TagTrace'],
            ['LinkMine', 'PulseEcho', 'GridSeam', 'YieldCast'],
            ['TunnelSync', 'ClaimLoop', 'QRDrillX', 'OreBeam'],
            ['GridGeo', 'VaultMap', 'RockForm', 'ClaimTunnel'],
            ['SeamSyncX', 'OreDrop', 'QRMineX', 'DrillMark'],
            ['ClaimOreX', 'TrackGrid', 'VaultDrop', 'PingEcho'],
            ['BlastMine', 'PulsePing', 'QRPath', 'SeamMark'],
            ['EchoRock', 'YieldTrack', 'VaultBeam', 'ClaimSync'],
            ['CrateDrop', 'SyncClaim', 'DrillForm', 'TunnelMap'],
            ['RockLogicX', 'VaultOre', 'YieldLoop', 'PingDrill'],
            ['CoreMine', 'OreTag', 'VaultPing', 'GridTrack'],
            ['MineCastX', 'ClaimNest', 'QRTrace', 'YieldEcho'],
            ['DrillMarkX', 'OreSignal', 'VaultCrate', 'PingTag'],
            ['OreSignalX', 'GridEcho', 'ClaimDrop', 'TrackTunnel'],
            ['TrackYield', 'MineFrame', 'SignalGrid', 'EchoDrill'],
            ['VaultSeamX', 'QRClaimX', 'GridOre', 'TunnelEcho'],
            ['DropShaft', 'ClaimTunnelX', 'YieldDrillX', 'VaultGrid'],
            ['GeoNodeX', 'SignalPing', 'DropEcho', 'MineLink']
        ];

        // Format mining brands into the structure expected by allSectorsData
        const miningSectorBrandsFormatted = miningBrandsRaw.map((brandName, index) => {
            return {
                name: brandName,
                subnodes: miningSubNodesRaw[index] || [] // Ensure it doesn't break if subnodes array is shorter
            };
        });


        // --- Centralized Data Store for CodeNest Dashboard ---
        const sectorList = {
            "agriculture": { name: "🌱 Agriculture & Biotech" },
            "fsf": { name: "🥦 Food, Soil & Farming" },
            "banking": { name: "🏦 Banking & Finance" },
            "creative": { name: "🖋️ Creative Tech" },
            "logistics": { name: "📦 Logistics & Packaging" },
            "education-ip": { name: "📚 Education & IP" },
            "fashion": { name: "✂ Fashion & Identity" },
            "gaming": { name: "🎮 Gaming & Simulation" },
            "health": { name: "🧠 Health & Hygiene" },
            "housing": { name: "🏗️ Housing & Infrastructure" },
            "justice": { name: "⚖ Justice & Ethics" },
            "knowledge": { name: "📖 Knowledge & Archives" },
            "micromesh": { name: "☰ Micro-Mesh Logistics" },
            "media": { name: "🎬 Motion, Media & Sonic" },
            "nutrition": { name: "✿ Nutrition & Food Chain" },
            "ai-logic": { name: "🧠 AI, Logic & Grid" },
            "packaging": { name: "📦 Packaging & Materials" },
            "quantum": { name: "✴️ Quantum Protocols" },
            "ritual": { name: "☯ Ritual & Culture" },
            "saas": { name: "🔑 SaaS & Licensing" },
            "trade": { name: "🧺 Trade Systems" },
            "utilities": { name: "🔋 Utilities & Energy" },
            "voice": { name: "🎙️ Voice & Audio" },
            "webless": { name: "📡 Webless Tech & Nodes" },
            "nft": { name: "🔁 NFT & Ownership" },
            "education-youth": { name: "🎓 Education & Youth" },
            "zerowaste": { name: "♻️ Zero Waste" },
            "professional": { name: "🧾 Professional Services" },
            "payroll-mining": { name: "🪙 Payroll Mining & Accounting" },
            "mining": { name: "⛏️ Mining & Resources" }, // This is the target sector
            "wildlife": { name: "🦁 Wildlife & Habitat" },
            "admin-panel": { name: "⚙️ CodeNest™ Central Hub" } // Updated to CodeNest
        };


        const allSectorsData = {
            // Updated Admin Panel to represent CodeNest explicitly
            "admin-panel": {
                name: "⚙️ CodeNest™ Central Hub",
                repoName: "codenest-global-admin",
                baseUrl: "codenest.faa.zone",
                brands: [
                    { name: "Core Services", subnodes: ["Project Management", "License Vault", "Deployment Pipelines", "User Access"] },
                    { name: "System Monitoring", subnodes: ["Health Dashboard", "Log Analysis", "Traffic Insights"] }
                ]
            },
            "mining": { // Mining sector data using the provided brands and subnodes
                name: "⛏️ Mining & Resources",
                repoName: "mining-seedwave-admin",
                baseUrl: "mining.seedwave.faa.zone",
                brands: miningSectorBrandsFormatted
            },
            "ai-logic": {
                name: "🧠 AI, Logic & Grid",
                repoName: "ai-logic-seedwave-admin",
                baseUrl: "ai-logic.seedwave.faa.zone",
                brands: [
                    { name: "OmniKey", subnodes: ["TraceBeam", "VaultEcho", "QRPath", "MeshID"] },
                    { name: "SignalPulse", subnodes: ["BeamNode", "VaultTrack", "QRLogic", "SignalDrop"] },
                    { name: "MeshIndex", subnodes: ["YieldTrack", "VaultMap", "QRClaim", "OmniPath"] }
                ]
            },
            "agriculture": {
                name: "🌱 Agriculture & Biotech",
                repoName: "agriculture-seedwave-admin",
                baseUrl: "agriculture.seedwave.faa.zone",
                brands: [
                    { name: "CropLink", subnodes: ["CropLink ID™", "CropLink Vault™", "CropLink Field™", "CropLink Yield™"] },
                    { name: "SoilPulse", subnodes: ["SoilPulse Trace™", "SoilPulse Data™", "SoilPulse Alert™"] }
                ]
            },
            "fsf": { 
                name: "🥦 Food, Soil & Farming",
                repoName: "fsf-seedwave-admin",
                baseUrl: "fsf.seedwave.faa.zone",
                brands: [{ name: "FarmFlow", subnodes: ["SoilScan", "WaterNet", "CropMonitor"] }] 
            },
            "banking": { 
                name: "🏦 Banking & Finance",
                repoName: "banking-seedwave-admin",
                baseUrl: "banking.seedwave.faa.zone",
                brands: [{ name: "CoinFlow", subnodes: ["LedgerTrack", "AssetVault"] }] 
            },
            "creative": { 
                name: "🖋️ Creative Tech",
                repoName: "creative-seedwave-admin",
                baseUrl: "creative.seedwave.faa.zone",
                brands: [{ name: "PixelFlow", subnodes: ["RenderEngine", "SonicWave", "VisualStory"] }] 
            },
            "logistics": { 
                name: "📦 Logistics & Packaging",
                repoName: "logistics-seedwave-admin",
                baseUrl: "logistics.seedwave.faa.zone",
                brands: [{ name: "CrateLogic", subnodes: ["RouteOptimize", "FleetTrack", "WarehouseSync"] }] 
            },
            "education-ip": { 
                name: "📚 Education & IP",
                repoName: "education-seedwave-admin",
                baseUrl: "education-ip.seedwave.faa.zone",
                brands: [{ name: "EduNest", subnodes: ["CurriculumForge", "LicenseTrack"] }] 
            },
            "fashion": { 
                name: "✂ Fashion & Identity",
                repoName: "fashion-seedwave-admin",
                baseUrl: "fashion.seedwave.faa.zone",
                brands: [{ name: "StyleFlow", subnodes: ["IdentityMesh", "TrendPulse"] }] 
            },
            "gaming": { 
                name: "🎮 Gaming & Simulation",
                repoName: "gaming-seedwave-admin",
                baseUrl: "gaming.seedwave.faa.zone",
                brands: [{ name: "GameGrid", subnodes: ["SimEngine", "RenderNode"] }] 
            },
            "health": { 
                name: "🧠 Health & Hygiene",
                repoName: "health-seedwave-admin",
                baseUrl: "health.seedwave.faa.zone",
                brands: [{ name: "MediVault", subnodes: ["DiagAI", "PatientLink"] }] 
            },
            "housing": { 
                name: "🏗️ Housing & Infrastructure",
                repoName: "housing-seedwave-admin",
                baseUrl: "housing.seedwave.faa.zone",
                brands: [{ name: "BuildFlow", subnodes: ["SmartGrid", "UrbanMesh"] }] 
            },
            "justice": { 
                name: "⚖ Justice & Ethics",
                repoName: "justice-seedwave-admin",
                baseUrl: "justice.seedwave.faa.zone",
                brands: [{ name: "EthiLock", subnodes: ["ComplianceScan", "VaultJustice"] }] 
            },
            "knowledge": { 
                name: "📖 Knowledge & Archives",
                repoName: "knowledge-seedwave-admin",
                baseUrl: "knowledge.seedwave.faa.zone",
                brands: [{ name: "LoreKeeper", subnodes: ["ArchiveSync", "MetaGrid"] }] 
            },
            "micromesh": { 
                name: "☰ Micro-Mesh Logistics",
                repoName: "micromesh-seedwave-admin",
                baseUrl: "micromesh.seedwave.faa.zone",
                brands: [{ name: "PicoFlow", subnodes: ["NanoTrack", "MicroRoute"] }] 
            },
            "media": { 
                name: "🎬 Motion, Media & Sonic",
                repoName: "media-seedwave-admin",
                baseUrl: "media.seedwave.faa.zone",
                brands: [{ name: "SoundWave", subnodes: ["VisualSync", "SonicForge"] }] 
            },
            "nutrition": { 
                name: "✿ Nutrition & Food Chain",
                repoName: "nutrition-seedwave-admin",
                baseUrl: "nutrition.seedwave.faa.zone",
                brands: [{ name: "NutriFlow", subnodes: ["FoodTrace", "YieldOpt"] }] 
            },
            "packaging": { 
                name: "📦 Packaging & Materials",
                repoName: "packaging-seedwave-admin",
                baseUrl: "packaging.seedwave.faa.zone",
                brands: [{ name: "PackSync", subnodes: ["MaterialTrace", "EcoPack"] }] 
            },
            "quantum": { 
                name: "✴️ Quantum Protocols",
                repoName: "quantum-seedwave-admin",
                baseUrl: "quantum.seedwave.faa.zone",
                brands: [{ name: "QuantumLock", subnodes: ["EntangleNode", "CipherStream"] }] 
            },
            "ritual": { 
                name: "☯ Ritual & Culture",
                repoName: "ritual-seedwave-admin",
                baseUrl: "ritual.seedwave.faa.zone",
                brands: [{ name: "CultureMesh", subnodes: ["TraditionVault", "EthnoSync"] }] 
            },
            "saas": { 
                name: "🔑 SaaS & Licensing",
                repoName: "saas-seedwave-admin",
                baseUrl: "saas.seedwave.faa.zone",
                brands: [{ name: "LicenseKey", subnodes: ["ClaimFlow", "TokenGate"] }] 
            },
            "trade": { 
                name: "🧺 Trade Systems",
                repoName: "trade-seedwave-admin",
                baseUrl: "trade.seedwave.faa.zone",
                brands: [{ name: "TradeFlow", subnodes: ["MarketSync", "SupplyLink"] }] 
            },
            "utilities": { 
                name: "🔋 Utilities & Energy",
                repoName: "utilities-seedwave-admin",
                baseUrl: "utilities.seedwave.faa.zone",
                brands: [{ name: "PowerGrid", subnodes: ["EnergyTrack", "DemandSync"] }] 
            },
            "voice": { 
                name: "🎙️ Voice & Audio",
                repoName: "voice-seedwave-admin",
                baseUrl: "voice.seedwave.faa.zone",
                brands: [{ name: "SonicFlow", subnodes: ["VoiceID", "AudioMesh"] }] 
            },
            "webless": { 
                name: "📡 Webless Tech & Nodes",
                repoName: "webless-seedwave-admin",
                baseUrl: "webless.seedwave.faa.zone",
                brands: [{ name: "ZeroWeb", subnodes: ["NodeConnect", "MeshPoint"] }] 
            },
            "nft": { 
                name: "🔁 NFT & Ownership",
                repoName: "nft-seedwave-admin",
                baseUrl: "nft.seedwave.faa.zone",
                brands: [{ name: "TokenVault", subnodes: ["ClaimChain", "ArtFlow"] }] 
            },
            "education-youth": { 
                name: "🎓 Education & Youth",
                repoName: "education-youth-seedwave-admin",
                baseUrl: "education-youth.seedwave.faa.zone",
                brands: [{ name: "FutureMind", subnodes: ["LearnPath", "SkillNode"] }] 
            },
            "zerowaste": { 
                name: "♻️ Zero Waste",
                repoName: "zerowaste-seedwave-admin",
                baseUrl: "zerowaste.seedwave.faa.zone",
                brands: [{ name: "EcoCycle", subnodes: ["RecycleTrack", "WasteOpt"] }] 
            },
            "professional": { 
                name: "🧾 Professional Services",
                repoName: "professional-seedwave-admin",
                baseUrl: "professional.seedwave.faa.zone",
                brands: [{ name: "ProServe", subnodes: ["ConsultFlow", "AdvisoryLink"] }] 
            },
            "payroll-mining": { 
                name: "🪙 Payroll Mining & Accounting",
                repoName: "payroll-mining-seedwave-admin",
                baseUrl: "payroll-mining.seedwave.faa.zone",
                brands: [{ name: "PayMine", subnodes: ["AccountSync", "LedgerFlow"] }] 
            },
            "wildlife": { 
                name: "🦁 Wildlife & Habitat",
                repoName: "wildlife-seedwave-admin",
                baseUrl: "wildlife.seedwave.faa.zone",
                brands: [{ name: "HabitatGuard", subnodes: ["EcoTrack", "BioLink"] }] 
            }
        };


        const companyData = {
            "minenest-corp": {
                name: "MineNest Corporation",
                sector_key: "mining",
                details: {
                    "Location": "Johannesburg, South Africa",
                    "CEO": "Thabo Ntlatleng",
                    "Primary Contact": "operations@minenest.com",
                    "Deployment Servers": "Africa (Managed by MineNest™)",
                    "Active Licenses": "All Mining & Resources Protocols",
                    "Compliance Standards": "ISO 14001, OHSAS 18001",
                    "Security Audit": "Bi-annual (Last: Q2 2025)",
                    "System Uptime (YTD)": "99.998%",
                    "VaultMesh Integration": "Full",
                    "ClaimRoot Integration": "Full"
                }
            },
            "drillcorex-ltd": {
                name: "DrillCoreX Ltd.",
                sector_key: "mining",
                details: {
                    "Location": "Perth, Australia",
                    "CEO": "Sarah O'Connell",
                    "Primary Contact": "support@drillcorex.com",
                    "Deployment Servers": "Asia-Pacific (Cloud-based)",
                    "Active Licenses": "DrillCoreX, CoreDrop",
                    "Compliance Standards": "Australian Mining Regs",
                    "Security Audit": "Annual",
                    "System Uptime (YTD)": "99.8%",
                    "VaultMesh Integration": "Partial",
                    "ClaimRoot Integration": "Enabled"
                }
            }
        };

        const appData = {
            user: {
                displayName: "MineOpsLead001",
                email: "mining.lead@example.com",
                defaultRegion: "local",
                autoClaim: "yes"
            },
            dashboard: {
                totalProjects: 780, // Total mine sites/projects
                liveScrolls: 450,    // Active drill rigs/operations
                monthlyRoyalties: 1200000, // Monthly ore yield in tonnes (or value)
                systemHealth: {
                    labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
                    datasets: [{
                        label: 'Ore Extraction Rate (tonnes/hr)',
                        data: [80, 85, 82, 88, 90, 92, 95, 93, 96, 98, 97, 99],
                        borderColor: 'rgba(0, 113, 227, 0.8)', // Blue
                        backgroundColor: 'rgba(0, 113, 227, 0.1)',
                        fill: true,
                        tension: 0.4
                    }, {
                        label: 'Equipment Downtime (%)',
                        data: [15, 12, 10, 8, 9, 7, 6, 5, 4, 3, 2.5, 2],
                        borderColor: 'rgba(184, 134, 11, 0.8)', // Gold
                        backgroundColor: 'rgba(184, 134, 11, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                }
            },
            projects: [], // Will be populated with thousands of mock projects
            projectLoadIndex: 0,
            projectsPerLoad: 12, // Number of projects to load at once

            licenses: [
                { id: 'MN-001', name: 'MineNest™ Enterprise Operational Suite', region: 'Global Deployment', royalty: '1.5%', activationDate: '2025-01-20', claimStatus: 'Enabled', verified: true, editorLink: '#' },
                { id: 'DCX-002', name: 'DrillCoreX™ Automated Rig License', region: 'Local Site', royalty: '0.8%', activationDate: '2025-02-10', claimStatus: 'Enabled', verified: true, editorLink: '#' },
                { id: 'OS-003', name: 'OreSync™ Real-time Flow Management', region: 'Local Site', royalty: '0.6%', activationDate: '2025-03-05', claimStatus: 'Pending Sync', verified: false, editorLink: '#' },
                { id: 'VR-004', name: 'VaultRock™ Geological Data Vault', region: 'Global Deployment', royalty: '2.0%', activationDate: '2025-04-01', claimStatus: 'Enabled', verified: true, editorLink: '#' },
            ],
            templates: [
                { name: 'Mine Site Overview Dashboard', description: 'Template for comprehensive real-time monitoring of a mining site.', link: '#', icon: 'fas fa-map-marked-alt',
                    previewHtml: `
                        <div style="background-color: #f5f5f7; color: #1d1d1f; padding: 2rem; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); text-align: center;">
                            <h1 style="font-size: 1.8rem; font-weight: 800; color: #0071e3; margin-bottom: 1rem;">MineNest™ | <span style="color: #B8860B;">Site Overview</span></h1>
                            <h2 style="font-size: 1.2rem; color: #424245; margin-bottom: 1.5rem;">Real-time Operational Metrics</h2>
                            <p style="font-size: 0.95rem; line-height: 1.5; color: #6e6e73;">Monitor ore flow, equipment status, and environmental compliance at a glance.</p>
                            <button style="background-color: #B8860B; color: white; padding: 0.75rem 1.5rem; border-radius: 8px; margin-top: 1.5rem; border: none; cursor: pointer;">View Live Data</button>
                        </div>
                    `
                },
                { name: 'Equipment Telemetry Dashboard', description: 'Track performance, uptime, and maintenance schedules for all mining equipment.', link: '#', icon: 'fas fa-cogs',
                    previewHtml: `
                        <div style="background-color: #f5f5f7; color: #1d1d1f; padding: 2rem; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); text-align: center;">
                            <h1 style="font-size: 1.8rem; font-weight: 800; color: #0071e3; margin-bottom: 1rem;">DrillCoreX™ | <span style="color: #B8860B;">Telemetry</span></h1>
                            <h2 style="font-size: 1.2rem; color: #424245; margin-bottom: 1.5rem;">Intelligent Equipment Monitoring</h2>
                            <p style="font-size: 0.95rem; line-height: 1.5; color: #6e6e73;">Optimize your fleet with predictive maintenance and real-time performance insights.</p>
                            <button style="background-color: #B8860B; color: white; padding: 0.75rem 1.5rem; border-radius: 8px; margin-top: 1.5rem; border: none; cursor: pointer;">Track Equipment</button>
                        </div>
                    `
                },
                { name: 'Geological Survey Map', description: 'Interactive map displaying geological data, drill core locations, and resource estimates.', link: '#', icon: 'fas fa-globe-americas',
                    previewHtml: `
                        <div style="background-color: #f5f5f7; color: #1d1d1f; padding: 2rem; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); text-align: center;">
                            <h1 style="font-size: 1.8rem; font-weight: 800; color: #0071e3; margin-bottom: 1rem;">VaultRock™ | <span style="color: #B8860B;">GeoMap</span></h1>
                            <h2 style="font-size: 1.2rem; color: #424245; margin-bottom: 1.5rem;">Interactive Geological Insights</h2>
                            <p style="font-size: 0.95rem; line-height: 1.5; color: #6e6e73;">Visualize your exploration data and identify new resource opportunities with precision.</p>
                            <button style="background-color: #B8860B; color: white; padding: 0.75rem 1.5rem; border-radius: 8px; margin-top: 1.5rem; border: none; cursor: pointer;">Explore Map</button>
                        </div>
                    `
                },
                { name: 'Environmental Compliance Report', description: 'Automated generation of environmental impact reports and regulatory compliance checklists.', link: '#', icon: 'fas fa-leaf',
                    previewHtml: `
                        <div style="background-color: #f5f5f7; color: #1d1d1f; padding: 2rem; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); text-align: center;">
                            <h1 style="font-size: 1.8rem; font-weight: 800; color: #0071e3; margin-bottom: 1rem;">EcoMine™ | <span style="color: #B8860B;">Compliance</span></h1>
                            <h2 style="font-size: 1.2rem; color: #424245; margin-bottom: 1.5rem;">Automated Environmental Reporting</h2>
                            <p style="font-size: 0.95rem; line-height: 1.5; color: #6e6e73;">Generate comprehensive reports to ensure your operations meet all environmental standards.</p>
                            <button style="background-color: #B8860B; color: white; padding: 0.75rem 1.5rem; border-radius: 8px; margin-top: 1.5rem; border: none; cursor: pointer;">Generate Report</button>
                        </div>
                    `
                },
            ],
            analytics: {
                deploymentTrends: {
                    labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
                    datasets: [{
                        label: 'New Mining Operations Deployed',
                        data: [15, 18, 22, 25, 23, 29],
                        borderColor: 'rgba(0, 113, 227, 0.8)',
                        backgroundColor: 'rgba(0, 113, 227, 0.2)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                royaltyDistribution: {
                    labels: ['Iron Ore', 'Copper', 'Gold', 'Coal', 'Other Minerals'],
                    datasets: [{
                        data: [40, 25, 20, 10, 5],
                        backgroundColor: ['#B8860B', '#0071e3', '#30d158', '#f59e0b', '#6e6e73'],
                        hoverOffset: 4
                    }]
                },
                userActivity: {
                    labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
                    datasets: [{
                        label: 'Active Operators (Daily Average)',
                        data: [120, 150, 140, 160, 170, 90, 70],
                        borderColor: 'rgba(0, 113, 227, 0.8)',
                        backgroundColor: 'rgba(0, 113, 227, 0.1)',
                        tension: 0.3,
                        fill: true
                    }, {
                        label: 'Equipment Uptime (Hours)',
                        data: [800, 950, 920, 1000, 1050, 500, 400],
                        borderColor: 'rgba(184, 134, 11, 0.8)',
                        backgroundColor: 'rgba(184, 134, 11, 0.1)',
                        tension: 0.3,
                        fill: true
                    }]
                }
            },
            apiKeys: [
                { service: "IoT Sensor Data Platform", key: "SENSORKEY123XYZABC", locations: ["Drill Rig Telemetry", "Mine Site Monitoring"] },
                { service: "Geological Survey API", key: "GEOAPIKEY987654", locations: ["VaultRock™", "Exploration Planning"] },
                { service: "Environmental Monitoring API", key: "ECOMONITORABCDEF", locations: ["Environmental Compliance Reports"] },
                { service: "Supply Chain Logistics Integration", key: "LOGISTICSAPI789DEF", locations: ["Ore Transport Tracking"] },
                { service: "Satellite Imagery & GIS", key: "SATIMGXYZ789", locations: ["Mine Site Mapping", "Resource Mapping"] }
            ],
            royaltyAgreements: [
                { id: 'RA-001-MN', name: 'MineNest™ Standard Operational License', status: 'Signed', link: '#', description: 'Standard agreement for general mining operations deployment, 1.5% standard royalty.' },
                { id: 'RA-002-DCX', name: 'DrillCoreX™ Partnership Agreement', status: 'Pending Signature', link: '#', description: 'Specialized agreement for automated drilling partners, 0.8% royalty, data sharing terms.' },
                { id: 'RA-003-OS', name: 'OreSync™ Integration Tier', status: 'Signed', link: '#', description: 'Tailored for real-time ore flow management systems, 0.6% royalty, data synchronization terms.' }
            ],
            // Add static color references here for Chart.js
            colors: {
                primary: null, secondary: null, textDark: null, borderColorDark: null, accentGold: null
            },
            // NEW: Domain and DNS Data
            dnsRecords: [
                { type: 'A', name: '@', value: '203.0.113.45', ttl: 'Auto' },
                { type: 'CNAME', name: 'www', value: '@', ttl: 'Auto' },
                { type: 'MX', name: '@', value: 'mail.minenest.faa.zone (Priority 10)', ttl: 'Auto' },
                { type: 'TXT', name: '@', value: 'v=spf1 include:minenest.faa.zone ~all', ttl: 'Auto' },
            ],
            emailAccounts: [
                { email: 'operations@minenest.faa.zone', status: 'Active' },
                { email: 'geology@minenest.faa.zone', status: 'Active' },
                { email: 'safety@minenest.faa.zone', status: 'Suspended' },
            ],
            domains: [
                { name: 'minenest.faa.zone', type: 'Primary' },
                { name: 'drillcorex.minenest.faa.zone', type: 'Subdomain' },
                { name: 'oresync.minenest.faa.zone', type: 'Subdomain' },
            ],
        };

        // Adding mock HTML content to projects for editor integration
        appData.projects = Array.from({ length: 780 }).map((_, i) => {
            const statuses = ['live', 'pending', 'draft', 'error'];
            const regions = ['Global Deployment', 'Local Site', 'Exploration Phase'];
            const types = ['Ore Extraction', 'Geological Survey', 'Equipment Maintenance', 'Drill Rig Deployment', 'Mine Site Logistics'];
            
            const id = `MINE-${1000 + i}`;
            const name = `${types[Math.floor(Math.random() * types.length)]} - ${i + 1}`;
            const status = statuses[Math.floor(Math.random() * statuses.length)];
            const region = regions[Math.floor(Math.random() * regions.length)];
            const royalty = `${(0.5 + Math.random() * 2).toFixed(1)}%`; // 0.5% to 2.5%
            const lastActivity = new Date(Date.now() - Math.random() * 60 * 24 * 60 * 60 * 1000).toLocaleDateString(); // Last 60 days

            let htmlContent = '';
            if (name.includes('Ore Extraction')) {
                htmlContent = `
<div style="background-color: #f5f5f7; color: #1d1d1f; padding: 2rem; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); text-align: center;">
    <h1 style="font-size: 1.8rem; font-weight: 800; color: #0071e3; margin-bottom: 1rem;">MineNest™ | <span style="color: #B8860B;">Extraction Dashboard</span></h1>
    <p style="font-size: 0.95rem; line-height: 1.5; color: #6e6e73;">Real-time monitoring of ore extraction rates and efficiency.</p>
    <img src="https://placehold.co/400x200/B8860B/FFFFFF?text=Ore+Graph" alt="Ore Graph" style="width: 100%; max-width: 400px; margin-top: 1.5rem; border-radius: 4px;">
</div>
                `;
            } else if (name.includes('Geological Survey')) {
                   htmlContent = `
<div style="background-color: #f5f5f7; color: #1d1d1f; padding: 2rem; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); text-align: center;">
    <h1 style="font-size: 1.8rem; font-weight: 800; color: #0071e3; margin-bottom: 1rem;">VaultRock™ | <span style="color: #B8860B;">GeoMap</span></h1>
    <p style="font-size: 0.95rem; line-height: 1.5; color: #6e6e73;">Interactive geological map for survey data analysis.</p>
    <img src="https://placehold.co/400x200/0071e3/FFFFFF?text=Geological+Map" alt="Geological Map" style="width: 100%; max-width: 400px; margin-top: 1.5rem; border-radius: 4px;">
</div>
               `;
            } else if (name.includes('Equipment Maintenance')) {
                htmlContent = `
<div style="background-color: #f5f5f7; color: #1d1d1f; padding: 2rem; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); text-align: center;">
    <h1 style="font-size: 1.8rem; font-weight: 800; color: #0071e3; margin-bottom: 1rem;">DrillCoreX™ | <span style="color: #B8860B;">Maintenance Log</span></h1>
    <p style="font-size: 0.95rem; line-height: 1.5; color: #6e6e73;">Automated log of equipment servicing and repair history.</p>
    <img src="https://placehold.co/400x200/B8860B/FFFFFF?text=Maintenance+Schedule" alt="Maintenance Schedule" style="width: 100%; max-width: 400px; margin-top: 1.5rem; border-radius: 4px;">
</div>
                `;
            } else {
                htmlContent = `
<div style="background-color: #f5f5f7; color: #1d1d1f; padding: 2rem; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); text-align: center;">
    <h1 style="font-size: 1.8rem; font-weight: 800; color: #0071e3; margin-bottom: 1rem;">MineNest™ | <span style="color: #B8860B;">${name}</span></h1>
    <p style="font-size: 0.95rem; line-height: 1.5; color: #6e6e73;">This is dynamic content for project ID: ${id}. Explore its operational details!</p>
</div>
                `;
            }
            return { id, name, status, region, royalty, lastActivity, htmlCode: htmlContent };
        });


        // --- Utility Functions ---

        // Global functions must be attached to window to be called by inline onclicks
        window.showCustomModal = function(title, message, autoDismiss = true) {
            const modal = document.getElementById('customModal');
            const modalMessage = modal.querySelector('p');
            if (modal && modalMessage) {
                modalMessage.innerHTML = `<strong>${title}</strong><br>${message}`;
                modal.classList.remove('hidden');
                if (autoDismiss) {
                    setTimeout(() => {
                        window.hideCustomModal();
                    }, 3000);
                }
            }
        };

        window.hideCustomModal = function() {
            document.getElementById('customModal')?.classList.add('hidden');
        };

        // --- Checkout Flow Functions ---
        window.showCheckoutStep = function(step) {
            // Hide all checkout steps
            document.querySelectorAll('[id^="checkout-step-"]').forEach(el => {
                el.classList.add('hidden');
            });
            // Show the requested step
            document.getElementById(`checkout-step-${step}`)?.classList.remove('hidden');
            // Reset payment status message
            document.getElementById('paymentStatus')?.classList.add('hidden');
            document.getElementById('orderStatus')?.classList.add('hidden');
        };

        window.processPayment = function() {
            const paymentStatus = document.getElementById('paymentStatus');
            const orderStatus = document.getElementById('orderStatus');
            paymentStatus.textContent = "Processing payment...";
            paymentStatus.classList.remove('hidden');
            
            // Simulate payment processing
            setTimeout(() => {
                paymentStatus.textContent = "Payment successful! Initiating ClaimRoot™ license...";
                paymentStatus.classList.add('text-green-400');
                paymentStatus.classList.remove('text-red-400'); // Ensure it's green
                window.showCheckoutStep(3); // Move to confirmation step
                orderStatus.textContent = "Status: ClaimRoot™ License Activated!";
                orderStatus.classList.remove('hidden');
            }, 2000);
        };

        window.resetCheckout = function() {
            window.showCheckoutStep(1); // Reset to first step
            document.getElementById('cardNumber').value = '';
            document.getElementById('expiryDate').value = '';
            document.getElementById('cvc').value = '';
            document.getElementById('paymentStatus').classList.add('hidden');
            document.getElementById('orderStatus').classList.add('hidden');
            document.getElementById('paymentStatus').classList.remove('text-green-400');
            document.getElementById('paymentStatus').classList.add('text-red-400'); // Reset to red for future errors
            showView('dashboard'); // Optionally go back to dashboard
        };


        // --- View Management (Client-side Router) ---
        let currentChartInstances = {}; // To store Chart.js instances for destruction

        function showView(viewId) {
            // Update URL hash
            window.location.hash = viewId;

            // Hide all views
            document.querySelectorAll('.main-content .view').forEach(view => {
                view.classList.add('view-hidden');
            });
            // Show the requested view
            document.getElementById(`${viewId}-view`)?.classList.remove('view-hidden');

            // Update active state in sidebar nav
            document.querySelectorAll('.sidebar .nav-list a').forEach(link => {
                if (link.getAttribute('data-view') === viewId) {
                    link.classList.add('active');
                } else {
                    link.classList.remove('active');
                }
            });

            // Handle view-specific rendering
            renderViewContent(viewId);
        }

        function renderViewContent(viewId) {
            // Destroy existing charts to prevent canvas errors on view change
            for (const chartId in currentChartInstances) {
                if (currentChartInstances[chartId]) {
                    currentChartInstances[chartId].destroy();
                    currentChartInstances[chartId] = null;
                }
            }

            if (viewId === 'dashboard') {
                updateDashboardMetrics();
                renderSystemHealthChart();
            } else if (viewId === 'projects') {
                appData.projectLoadIndex = 0; // Reset load index when entering projects view
                renderProjects();
            } else if (viewId === 'ecosystem-map') {
                renderEcosystemMap(); // NEW: Render the ecosystem map
            } else if (viewId === 'global-checkout') {
                window.showCheckoutStep(1); // Always start simulated checkout at step 1
                renderPayPalButtons(); // Render PayPal buttons when entering this view
            }
            else if (viewId === 'templates') {
                renderTemplates(); // Ensure templates are rendered
            } else if (viewId === 'licenses') {
                renderLicenses();
                renderRoyaltyAgreements(); // Render new section
            } else if (viewId === 'analytics') {
                renderAnalyticsCharts();
            } else if (viewId === 'api-keys') {
                renderApiKeysTable();
            } else if (viewId === 'settings') {
                loadSettings();
                showSettingsTab('profile'); // Default to profile tab when entering settings
            } else if (viewId === 'login' || viewId === 'signup') {
                // Clear forms on view change
                document.getElementById('loginForm')?.reset();
                document.getElementById('signupForm')?.reset();
            }
        }

        // --- Dashboard Specific Logic ---
        function updateDashboardMetrics() {
            document.getElementById('totalProjectsCount').textContent = appData.dashboard.totalProjects.toLocaleString();
            document.getElementById('liveScrollsCount').textContent = appData.dashboard.liveScrolls.toLocaleString();
            document.getElementById('monthlyRoyalties').textContent = appData.dashboard.monthlyRoyalties.toLocaleString(); // Display as number, not currency
        }

        function renderSystemHealthChart() {
            const ctx = document.getElementById('systemHealthChart')?.getContext('2d');
            if (ctx) {
                currentChartInstances.systemHealthChart = new Chart(ctx, {
                    type: 'line',
                    data: appData.dashboard.systemHealth,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                labels: {
                                    color: document.body.classList.contains('light-mode') ? appData.colors.textDark : 'white',
                                    font: { family: 'Inter' }
                                }
                            }
                        },
                        scales: {
                            x: {
                                ticks: { color: document.body.classList.contains('light-mode') ? appData.colors.textDark : 'white' },
                                grid: { color: document.body.classList.contains('light-mode') ? 'rgba(0,0,0,0.1)' : 'rgba(255,255,255,0.1)' }
                            },
                            y: {
                                ticks: { color: document.body.classList.contains('light-mode') ? appData.colors.textDark : 'white' },
                                grid: { color: document.body.classList.contains('light-mode') ? 'rgba(0,0,0,0.1)' : 'rgba(255,255,255,0.1)' }
                            }
                        }
                    }
                });
            }
        }

        // --- Projects View Logic ---
        function renderProjects(append = false) {
            const projectsListContainer = document.getElementById('projectsList');
            if (!projectsListContainer) return;

            if (!append) {
                projectsListContainer.innerHTML = ''; // Clear existing projects unless appending
                appData.projectLoadIndex = 0;
            }

            const searchTerm = document.getElementById('projectSearch')?.value.toLowerCase() || '';
            const filterStatus = document.getElementById('projectFilterStatus')?.value || 'all';

            // Apply search and filter to all projects first
            const filteredProjects = appData.projects.filter(project => {
                const matchesSearch = project.name.toLowerCase().includes(searchTerm) || project.id.toLowerCase().includes(searchTerm);
                const matchesStatus = filterStatus === 'all' || project.status === filterStatus;
                return matchesSearch && matchesStatus;
            });

            // Determine which projects to render based on load index
            const projectsToRender = filteredProjects.slice(appData.projectLoadIndex, appData.projectLoadIndex + appData.projectsPerLoad);

            projectsToRender.forEach(project => {
                const projectCard = document.createElement('div');
                projectCard.className = 'project-card';
                // Adjust status display for mining context
                let displayStatus = project.status;
                if (project.status === 'live') displayStatus = 'Active';
                if (project.status === 'pending') displayStatus = 'Exploration';
                if (project.status === 'draft') displayStatus = 'Planned';
                if (project.status === 'error') displayStatus = 'Maintenance';


                projectCard.innerHTML = `
                    <h4 class="mb-2">${project.name}</h4>
                    <p><strong>ID:</strong> ${project.id}</p>
                    <p><strong>Region:</strong> ${project.region}</p>
                    <p><strong>Royalty:</strong> ${project.royalty}</p>
                    <p><strong>Last Activity:</strong> ${project.lastActivity}</p>
                    <span class="project-status status-${project.status}">${displayStatus.toUpperCase()}</span>
                    <div class="project-actions">
                        <button onclick="window.openProjectInEditor('${project.id}')">
                            <i class="fas fa-edit mr-1"></i> Editor
                        </button>
                        <button class="secondary" onclick="window.showCustomModal('Action', 'Viewing live operational data for ${project.name} (ID: ${project.id})...')">
                            <i class="fas fa-globe mr-1"></i> Live
                        </button>
                        <button class="form-action-button text-xs px-3 py-2 mt-2" onclick="window.summarizeProject('${project.id}', this)">
                            ✨ Summarize Project
                        </button>
                        <p id="projectSummaryStatus-${project.id}" class="text-xs text-gray-400 mt-1 hidden"></p>
                    </div>
                `;
                projectsListContainer.appendChild(projectCard);
            });

            appData.projectLoadIndex += projectsToRender.length;

            const loadMoreButton = document.getElementById('loadMoreProjects');
            if (loadMoreButton) {
                if (appData.projectLoadIndex >= filteredProjects.length) {
                    loadMoreButton.classList.add('view-hidden'); // Hide if no more projects
                } else {
                    loadMoreButton.classList.remove('view-hidden');
                }
            }
        }

        // Function to open a project in the integrated editor (NEW)
        window.openProjectInEditor = function(projectId) {
            const project = appData.projects.find(p => p.id === projectId);
            if (project) {
                document.getElementById('editorHtmlCssCode').value = project.htmlCode;
                document.getElementById('currentProjectEditName').textContent = `${project.name} Editor`;
                window.updateEditorPreview(); // Update the preview with the loaded code
                showView('editor-workspace'); // Switch to the editor view
            } else {
                window.showCustomModal('Project Not Found', `Could not find project with ID: ${projectId}`);
            }
        };

        // Function to summarize a project (NEW FEATURE)
        window.summarizeProject = async function(projectId, buttonElement) {
            const project = appData.projects.find(p => p.id === projectId);
            if (!project) {
                window.showCustomModal('Error', 'Project not found for summarization.');
                return;
            }

            const statusElementId = `projectSummaryStatus-${projectId}`;
            const statusElement = document.getElementById(statusElementId);

            const prompt = `Summarize the following mining project details concisely (max 80 words):
            Project Name: ${project.name}
            ID: ${project.id}
            Status: ${project.status}
            Region: ${project.region}
            Royalty: ${project.royalty}
            Last Activity: ${project.lastActivity}

            Highlight the project's current state and main purpose within mining operations.`;
            
            // Using a temporary invisible element for the target, as the output goes to a modal
            const tempOutputDiv = document.createElement('div');
            tempOutputDiv.id = `tempProjectSummaryOutput-${projectId}`;
            tempOutputDiv.style.display = 'none'; // Keep it hidden
            document.body.appendChild(tempOutputDiv);

            const summaryText = await window.callGeminiAPI(prompt, tempOutputDiv.id, statusElementId, buttonElement, 'Summarize Project');

            if (summaryText) {
                window.showProjectSummaryModal(`${project.name} Summary`, summaryText);
            } else {
                window.showCustomModal('Summarization Failed', 'Could not generate project summary. Please try again.');
            }
            document.body.removeChild(tempOutputDiv); // Clean up the temporary element
        };

        // Event listeners for project search/filter
        document.getElementById('projectSearch')?.addEventListener('input', () => renderProjects(false));
        document.getElementById('projectFilterStatus')?.addEventListener('change', () => renderProjects(false));
        document.getElementById('loadMoreProjects')?.addEventListener('click', () => renderProjects(true));


        // --- Gemini API Call Function ---
        window.callGeminiAPI = async function(prompt, targetElementId, statusElementId, buttonElement, type, parseJson = false) {
            const targetElement = document.getElementById(targetElementId);
            const statusElement = document.getElementById(statusElementId);
            
            if (!targetElement || !statusElement || !buttonElement) {
                console.error("Missing target, status element, or button element for Gemini API call.");
                return null; // Return null on error
            }

            statusElement.textContent = "Generating...";
            statusElement.classList.remove('hidden');
            if (targetElementId !== 'tempSimplifyOutput' && !targetElementId.startsWith('tempProjectSummaryOutput')) { // Don't hide the temp div used for simplification or project summary
                targetElement.classList.add('hidden'); // Hide output until ready
            }
            buttonElement.disabled = true;
            buttonElement.innerHTML = `<span class="inline-block border-4 border-t-blue-500 border-gray-300 rounded-full w-5 h-5 animate-spin"></span>`; // Show spinner

            try {
                let chatHistory = [];
                chatHistory.push({ role: "user", parts: [{ text: prompt }] });
                const payload = { contents: chatHistory };
                const apiKey = ""; // Canvas will automatically provide the API key
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();
                
                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const text = result.candidates[0].content.parts[0].text;
                    
                    if (parseJson) {
                        try {
                            const jsonResult = JSON.parse(text);
                            statusElement.textContent = "Generation complete!";
                            return jsonResult; // Return the parsed JSON object
                        } catch (jsonError) {
                            console.error("Failed to parse JSON from Gemini API:", jsonError);
                            statusElement.textContent = "Error: Could not parse AI response as JSON.";
                            return null;
                        }
                    } else {
                        // Check if the target is a textarea (has .value) or a general element (use .innerHTML)
                        if (targetElement.tagName === 'TEXTAREA' || targetElement.tagName === 'INPUT') {
                            targetElement.value = text;
                        } else {
                            targetElement.innerHTML = text; // For div or p tags
                        }
                        targetElement.classList.remove('hidden'); // Show output
                        statusElement.textContent = "Generation complete!";
                        return text; // Return the raw text
                    }
                } else {
                    statusElement.textContent = "Error: No content generated by AI.";
                    console.error("Gemini API returned an unexpected structure or no content:", result);
                    return null;
                }
            } catch (error) {
                statusElement.textContent = "Error: API call failed.";
                console.error("Error calling Gemini API:", error);
                return null;
            } finally {
                buttonElement.disabled = false;
                // Restore button text based on 'type' (from parameter)
                let originalButtonText = '';
                if (type === 'AI Generate') {
                    originalButtonText = 'AI Generate';
                } else if (type === 'Summarize Project') {
                    originalButtonText = 'Summarize Project';
                } else if (type === 'Simplify Agreement') {
                    originalButtonText = 'Simplify Agreement';
                } else if (type === 'Refine Code') {
                    originalButtonText = `Refine Code`;
                } else if (type === 'Explain Code') {
                    originalButtonText = `Explain Code`;
                } else if (type === 'Review Code') {
                    originalButtonText = `Review Code`;
                } else if (type === 'Generate Headline') {
                    originalButtonText = `Generate Headline`;
                } else if (type === 'Generate CTA') {
                    originalButtonText = `Generate CTA`;
                } else if (type === 'Generate Section Content') {
                    originalButtonText = `Generate Section Content`;
                } else if (type === 'Rephrase/Improve') {
                    originalButtonText = `Rephrase/Improve`;
                } else if (type === 'Explain DNS Type') {
                    originalButtonText = 'Explain DNS Type';
                } else if (type === 'Draft Email') {
                    originalButtonText = 'Generate Draft';
                }
                else {
                    originalButtonText = 'Action'; // Fallback
                }
                
                buttonElement.innerHTML = `✨ ${originalButtonText}`;
                setTimeout(() => statusElement.classList.add('hidden'), 3000); // Hide status after a few seconds
            }
        };


        // --- New Project Form Logic (with Gemini API Integration) ---
        document.getElementById('newProjectForm')?.addEventListener('submit', function(event) {
            event.preventDefault();
            const projectName = document.getElementById('projectName').value;
            const template = document.getElementById('template').value;
            const description = document.getElementById('description').value;
            const region = document.getElementById('region').value;
            const claim = document.getElementById('claim').value;

            // Simulate project creation
            const newProjectId = `MINE-${Math.floor(Math.random() * 10000)}`;
            let baseHtmlContent = '';
            const selectedTemplate = appData.templates.find(t => t.name === template);
            if (selectedTemplate && selectedTemplate.previewHtml) {
                // Remove outer div from previewHtml to integrate cleanly
                baseHtmlContent = selectedTemplate.previewHtml.replace(/<div[^>]*>|<\/div>/g, '');
            } else {
                baseHtmlContent = `<div style="background-color: #f5f5f7; color: #1d1d1f; padding: 2rem; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); text-align: center;"><h1>New Mining Project: ${projectName}</h1><p>This is a new mining operation project created from template: ${template}.</p></div>`;
            }

            const newProject = {
                id: newProjectId,
                name: projectName,
                status: 'draft',
                region: region === 'global' ? 'Global Deployment' : (region === 'local' ? 'Local Site' : 'Exploration Phase'),
                royalty: claim === 'yes' ? '1.5%' : 'N/A', // Updated royalty
                lastActivity: new Date().toLocaleDateString(),
                htmlCode: baseHtmlContent
            };
            appData.projects.unshift(newProject); // Add to the beginning of projects array
            appData.dashboard.totalProjects++; // Update total count

            window.showCustomModal('Project Created!', `Your project "${projectName}" (ID: ${newProjectId}) has been created. Status: Planned.`);

            // Optionally clear form
            this.reset();
            // Go to projects view
            showView('projects');
        });

        // Event listener for Generate Description Button
        document.getElementById('generateDescriptionBtn')?.addEventListener('click', async (event) => {
            const projectName = document.getElementById('projectName').value.trim();
            const templateSelect = document.getElementById('template');
            const templateType = templateSelect.options[templateSelect.selectedIndex].textContent; // Get displayed text
            const region = document.getElementById('region').value;
            const button = event.currentTarget; // Get the button element

            if (!projectName) {
                window.showCustomModal('Input Required', 'Please enter a Project Name to generate a description.');
                return;
            }

            const prompt = `Generate a concise and engaging project description (max 100 words, 3-4 sentences) for a mining and resources project named '${projectName}' of type '${templateType}' intended for a '${region}' deployment. Focus on operational goals, resource types, and potential impact.`;
            await window.callGeminiAPI(prompt, 'description', 'descriptionStatus', button, 'AI Generate');
        });

        // Event listener for Generate Project Idea Button
        document.getElementById('generateProjectIdeaBtn')?.addEventListener('click', async (event) => {
            const projectConcept = document.getElementById('projectConcept').value.trim();
            const button = event.currentTarget; // Get the button element
            const statusElement = document.getElementById('projectIdeaStatus');

            if (!projectConcept) {
                window.showCustomModal('Input Required', 'Please enter a high-level project concept to generate an idea.');
                return;
            }
            
            statusElement.textContent = "Generating project idea...";
            statusElement.classList.remove('hidden');

            const availableTemplates = appData.templates.map(t => t.name).join(', ');
            const prompt = `Generate a creative project name (max 5 words), a 3-4 sentence project description highlighting operational and strategic benefits for a mining project, and suggest one suitable template from the following list: ${availableTemplates}. The project is about: "${projectConcept}". Respond as a JSON object with keys: "projectName", "projectDescription", "suggestedTemplate".`;
            
            const aiIdea = await window.callGeminiAPI(prompt, 'hiddenIdeaOutput', 'projectIdeaStatus', button, 'AI Generate', true); // Use a hidden output element, parse JSON

            if (aiIdea) {
                window.showProjectIdeaModal(aiIdea.projectName, aiIdea.projectDescription, aiIdea.suggestedTemplate);
            } else {
                statusElement.textContent = "Failed to generate project idea. Please try again.";
            }
        });


        // --- Content Builder Form Logic (with Gemini API Integration) ---
        document.getElementById('scrollBuilderForm')?.addEventListener('submit', function(event) {
            event.preventDefault();
            window.showCustomModal('Content Compiled & Saved!', 'Your content has been compiled and saved to your workspace. It\'s now ready for deployment via Fruitful Global.');
            this.reset(); // Clear form
        });

        // Event listeners for Code Refinement Buttons
        document.getElementById('refineHtmlBtn')?.addEventListener('click', async (event) => {
            const htmlCode = document.getElementById('htmlCode').value;
            const button = event.currentTarget; // Get the button element
            document.getElementById('htmlExplanationOutput').classList.add('hidden'); // Hide explanation if refining
            document.getElementById('htmlReviewOutput').classList.add('hidden'); // Hide review if refining
            if (!htmlCode.trim()) { window.showCustomModal('Input Required', 'Please paste HTML code to refine.'); return; }
            const prompt = `Refine the following HTML code for better accessibility, semantic structure, and performance, specifically for displaying mining data, maps, or operational dashboards. Provide the refined code only, no explanations. \n\n${htmlCode}`;
            await window.callGeminiAPI(prompt, 'htmlCode', 'htmlRefineStatus', button, 'Refine Code');
        });

        document.getElementById('refineCssBtn')?.addEventListener('click', async (event) => {
            const cssCode = document.getElementById('cssCode').value;
            const button = event.currentTarget; // Get the button element
            document.getElementById('cssExplanationOutput').classList.add('hidden'); // Hide explanation if refining
            document.getElementById('cssReviewOutput').classList.add('hidden'); // Hide review if refining
            if (!cssCode.trim()) { window.showCustomModal('Input Required', 'Please paste CSS code to refine.'); return; }
            const prompt = `Optimize the following CSS code for efficiency, readability, and modern practices, focusing on visual elements relevant to mining dashboards and data displays. Provide the refined code only, no explanations. \n\n${cssCode}`;
            await window.callGeminiAPI(prompt, 'cssCode', 'cssRefineStatus', button, 'Refine Code');
        });

        document.getElementById('refineJsBtn')?.addEventListener('click', async (event) => {
            const jsCode = document.getElementById('jsCode').value;
            const button = event.currentTarget; // Get the button element
            document.getElementById('jsExplanationOutput').classList.add('hidden'); // Hide explanation if refining
            document.getElementById('jsReviewOutput').classList.add('hidden'); // Hide review if refining
            if (!jsCode.trim()) { window.showCustomModal('Input Required', 'Please paste JavaScript code to refine.'); return; }
            const prompt = `Refactor and optimize the following JavaScript code for readability, performance, and best practices, specifically for processing real-time mining sensor data, displaying geospatial data, or interactive operational controls. Provide the refined code only, no explanations. \n\n${jsCode}`;
            await window.callGeminiAPI(prompt, 'jsCode', 'jsRefineStatus', button, 'Refine Code');
        });

        // Event listeners for Code Explanation Buttons
        document.getElementById('explainHtmlBtn')?.addEventListener('click', async (event) => {
            const htmlCode = document.getElementById('htmlCode').value;
            const button = event.currentTarget;
            document.getElementById('htmlReviewOutput').classList.add('hidden'); // Hide review if explaining
            if (!htmlCode.trim()) { window.showCustomModal('Input Required', 'Please paste HTML code to explain.'); return; }
            const prompt = `Explain the key components and their purpose in the following HTML code, particularly focusing on elements related to displaying mining data, such as charts, maps, or interactive tables. Provide a high-level explanation. \n\n${htmlCode}`;
            await window.callGeminiAPI(prompt, 'htmlExplanationOutput', 'htmlRefineStatus', button, 'Explain Code');
        });

        document.getElementById('explainCssBtn')?.addEventListener('click', async (event) => {
            const cssCode = document.getElementById('cssCode').value;
            const button = event.currentTarget;
            document.getElementById('cssReviewOutput').classList.add('hidden'); // Hide review if explaining
            if (!cssCode.trim()) { window.showCustomModal('Input Required', 'Please paste CSS code to explain.'); return; }
            const prompt = `Explain the purpose of the main CSS rules and how they affect the layout and appearance of the page, especially any styling related to mining dashboards, data visualization, or equipment displays. \n\n${cssCode}`;
            await window.callGeminiAPI(prompt, 'cssExplanationOutput', 'cssRefineStatus', button, 'Explain Code');
        });

        document.getElementById('explainJsBtn')?.addEventListener('click', async (event) => {
            const jsCode = document.getElementById('jsCode').value;
            const button = event.currentTarget;
            document.getElementById('jsReviewOutput').classList.add('hidden'); // Hide review if explaining
            if (!jsCode.trim()) { window.showCustomModal('Input Required', 'Please paste JavaScript code to explain.'); return; }
            const prompt = `Explain the main functions and logic of the following JavaScript code, focusing on its interaction with mining data, real-time telemetry, or mapping functionalities. \n\n${jsCode}`;
            await window.callGeminiAPI(prompt, 'jsExplanationOutput', 'jsRefineStatus', button, 'Explain Code');
        });

        // Event listeners for Code Review Buttons
        document.getElementById('reviewHtmlBtn')?.addEventListener('click', async (event) => {
            const htmlCode = document.getElementById('htmlCode').value;
            const button = event.currentTarget;
            document.getElementById('htmlExplanationOutput').classList.add('hidden'); // Hide explanation if reviewing
            if (!htmlCode.trim()) { window.showCustomModal('Input Required', 'Please paste HTML code to review.'); return; }
            const prompt = `Provide a detailed code review for the following HTML, with a focus on best practices for displaying complex mining data, interactive maps, or sensor dashboards. Point out potential issues, suggest improvements for performance (e.g., data loading, rendering), accessibility, and semantic structure. Use a clear, constructive tone. \n\n${htmlCode}`;
            await window.callGeminiAPI(prompt, 'htmlReviewOutput', 'htmlRefineStatus', button, 'Review Code');
        });

        document.getElementById('reviewCssBtn')?.addEventListener('click', async (event) => {
            const cssCode = document.getElementById('cssCode').value;
            const button = event.currentTarget;
            document.getElementById('cssExplanationOutput').classList.add('hidden'); // Hide explanation if reviewing
            if (!cssCode.trim()) { window.showCustomModal('Input Required', 'Please paste CSS code to review.'); return; }
            const prompt = `Provide a detailed code review for the following CSS, with a focus on styling for mining dashboards, data visualizations, and operational interfaces. Suggest improvements for responsiveness, cross-browser compatibility, and clarity of data presentation. Identify any redundant or conflicting styles. Use a clear, constructive tone. \n\n${cssCode}`;
            await window.callGeminiAPI(prompt, 'cssReviewOutput', 'cssRefineStatus', button, 'Review Code');
        });

        document.getElementById('reviewJsBtn')?.addEventListener('click', async (event) => {
            const jsCode = document.getElementById('jsCode').value;
            const button = event.currentTarget;
            document.getElementById('jsExplanationOutput').classList.add('hidden'); // Hide explanation if reviewing
            if (!jsCode.trim()) { window.showCustomModal('Input Required', 'Please paste JavaScript code to review.'); return; }
            const prompt = `Provide a detailed code review for the following JavaScript, with a focus on logic for real-time mining data processing, map interactions, or equipment control systems. Suggest improvements for performance, error handling, data integrity, and adherence to modern best practices. Identify potential bugs or security vulnerabilities. Use a clear, constructive tone. \n\n${jsCode}`;
            await window.callGeminiAPI(prompt, 'jsReviewOutput', 'jsRefineStatus', button, 'Review Code');
        });


        // Event listener for Generate Content Ideas Button
        document.getElementById('generateContentIdeasBtn')?.addEventListener('click', async (event) => {
            const scrollTopic = document.getElementById('scrollTopic').value.trim();
            const button = event.currentTarget; // Get the button element
            if (!scrollTopic) {
                window.showCustomModal('Input Required', 'Please enter a topic to generate content ideas.');
                return;
            }
            const prompt = `Generate 5 creative and engaging content section ideas for a web page about "${scrollTopic}", specifically for mining and resources. For each idea, provide a catchy title and a brief 1-2 sentence description. Format the output as a Markdown list.`;
            await window.callGeminiAPI(prompt, 'contentIdeasOutput', 'contentIdeasStatus', button, 'AI Generate');
        });


        // --- File Upload & URL Import Functions ---

        // Generic File Upload Handler
        function setupFileUpload(inputId, textareaId, statusId) {
            document.getElementById(inputId)?.addEventListener('change', function(event) {
                const file = event.target.files[0];
                const statusElement = document.getElementById(statusId);
                const textarea = document.getElementById(textareaId);

                if (!file) {
                    statusElement.textContent = 'No file selected.';
                    statusElement.classList.remove('hidden');
                    setTimeout(() => statusElement.classList.add('hidden'), 3000);
                    return;
                }

                const reader = new FileReader();
                reader.onload = (e) => {
                    textarea.value = e.target.result;
                    statusElement.textContent = `File "${file.name}" loaded successfully.`;
                    statusElement.classList.remove('hidden');
                    setTimeout(() => statusElement.classList.add('hidden'), 3000);
                };
                reader.onerror = () => {
                    statusElement.textContent = `Error reading file "${file.name}".`;
                    statusElement.classList.remove('hidden');
                    setTimeout(() => statusElement.classList.add('hidden'), 3000);
                };
                reader.readAsText(file);
            });
        }

        // Generic URL Import Handler
        function setupUrlImport(buttonId, urlInputId, textareaId, statusId) {
            document.getElementById(buttonId)?.addEventListener('click', async function() {
                const url = document.getElementById(urlInputId).value.trim();
                const statusElement = document.getElementById(statusId);
                const textarea = document.getElementById(textareaId);

                if (!url) {
                    window.showCustomModal('Input Required', 'Please enter a URL to import code from.');
                    return;
                }

                statusElement.textContent = 'Importing from URL...';
                statusElement.classList.remove('hidden');
                // Temporarily disable elements
                document.getElementById(buttonId).disabled = true;
                document.getElementById(urlInputId).disabled = true;

                try {
                    const response = await fetch(url);
                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }
                    const text = await response.text();
                    textarea.value = text;
                    statusElement.textContent = 'Code imported successfully from URL.';
                } catch (error) {
                    statusElement.textContent = `Error importing code: ${error.message}`;
                    console.error('URL Import Error:', error);
                    window.showCustomModal('Import Error', `Failed to import code from URL: ${error.message}`, true);
                } finally {
                    document.getElementById(buttonId).disabled = false;
                    document.getElementById(urlInputId).disabled = false;
                    setTimeout(() => statusElement.classList.add('hidden'), 3000);
                }
            });
        }


        // --- Templates View Logic ---
        function renderTemplates() {
            const templatesGrid = document.getElementById('templatesGrid');
            if (!templatesGrid) return;
            templatesGrid.innerHTML = ''; // Clear existing templates

            appData.templates.forEach(template => {
                const templateCard = document.createElement('div');
                templateCard.className = 'panel bg-gray-900 border border-gray-700'; // Apply consistent panel styling
                
                // Construct inner HTML
                templateCard.innerHTML = `
                    <h4 class="mb-2"><i class="${template.icon} mr-2"></i> ${template.name}</h4>
                    <p class="text-gray-400 text-sm">${template.description}</p>
                `;
                // Create button separately and attach event listener
                const useTemplateButton = document.createElement('button');
                useTemplateButton.className = 'form-action-button mt-4';
                useTemplateButton.textContent = 'Use This Template';
                useTemplateButton.addEventListener('click', () => {
                    window.showTemplatePreviewModal(template); // Show template preview
                });
                templateCard.appendChild(useTemplateButton); // Append button to card

                templatesGrid.appendChild(templateCard);
            });
            // Ensure templates dropdowns are also populated when this view renders
            populateTemplateSelects();
        }

        // Helper function to populate template selects (called during initial load and template view render)
        function populateTemplateSelects() {
            const newProjectTemplateSelect = document.querySelector('#new-project-view #template');
            if(newProjectTemplateSelect) {
                newProjectTemplateSelect.innerHTML = appData.templates.map(t => `<option value="${t.name}">${t.name}</option>`).join(''); // Using name as value for simplicity
                newProjectTemplateSelect.insertAdjacentHTML('afterbegin', '<option value="">Select a template...</option>');
                newProjectTemplateSelect.value = ""; // Default empty
            }

            const scrollBuilderTemplateSelect = document.querySelector('#scroll-builder-view #sbScrollType');
            if(scrollBuilderTemplateSelect) {
                scrollBuilderTemplateSelect.innerHTML = `
                    <option value="">Select a content type...</option>
                    <option value="mine-site-dashboard">Mine Site Dashboard</option>
                    <option value="equipment-telemetry">Equipment Telemetry</option>
                    <option value="geological-map">Geological Map</option>
                    <option value="compliance-report">Compliance Report</option>
                   `;
            }
        }

        // --- Template Preview Modal Logic ---
        window.showTemplatePreviewModal = function(template) {
            const modal = document.getElementById('templatePreviewModal');
            const previewTitle = document.getElementById('templatePreviewTitle');
            const previewFrame = document.getElementById('templatePreviewFrame');
            const previewDescription = document.getElementById('templatePreviewDescription');
            const useTemplateNewProjectBtn = document.getElementById('useTemplateNewProjectBtn');
            const useTemplateScrollBuilderBtn = document.getElementById('useTemplateScrollBuilderBtn');

            if (!modal || !previewTitle || !previewFrame || !previewDescription || !useTemplateNewProjectBtn || !useTemplateScrollBuilderBtn) return;

            previewTitle.textContent = template.name;
            previewDescription.textContent = template.description;
            
            // Set iframe srcdoc with the template's preview HTML
            previewFrame.srcdoc = `
                <!DOCTYPE html>
                <html lang="en">
                <head>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <title>Preview</title>
                    <style>
                        /* Common preview styles, ensure colors match the current dashboard theme (light/dark) */
                        body { 
                            font-family: 'Inter', sans-serif; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; padding: 1rem; text-align: center; 
                            background-color: ${document.body.classList.contains('light-mode') ? '#f8f8f8' : '#1a1a1c'}; 
                            color: ${document.body.classList.contains('light-mode') ? '#1d1d1f' : '#f5f5f7'};
                        }
                        h1 { 
                            font-size: 1.8rem; font-weight: 800; margin-bottom: 1rem;
                            color: #0071e3; /* Primary Blue */
                        }
                        h1 span {
                            color: #B8860B; /* Accent Gold */
                        }
                        h2 { 
                            font-size: 1.2rem; color: ${document.body.classList.contains('light-mode') ? '#424245' : '#a0a0a5'}; margin-bottom: 1.5rem; 
                        }
                        p { 
                            font-size: 0.95rem; line-height: 1.5; 
                            color: ${document.body.classList.contains('light-mode') ? '#6e6e73' : '#b0b0b0'}; 
                        }
                        button { 
                            background-color: #B8860B; 
                            color: white; padding: 0.75rem 1.5rem; border-radius: 8px; margin-top: 1.5rem; border: none; cursor: pointer;
                        }
                        img {
                            width: 80%;
                            max-width: 400px;
                            margin: 1.5rem auto;
                            display: block;
                        }
                    </style>
                </head>
                <body>
                    ${template.previewHtml}
                </body>
                </html>
            `;
            
            // Set up action buttons to select template in forms
            useTemplateNewProjectBtn.onclick = () => {
                window.hideTemplatePreviewModal();
                showView('new-project');
                const selectElement = document.querySelector('#new-project-view #template');
                if (selectElement) { selectElement.value = template.name; } // Set value to template name
            };

            useTemplateScrollBuilderBtn.onclick = () => {
                window.hideTemplatePreviewModal();
                window.showCustomModal('Feature Not Fully Implemented', 'This feature is currently in development. Please select the template in the Content Builder manually.', true); // Informative message
                showView('scroll-builder');
            };


            modal.classList.add('active'); // Show modal with animation
        };

        window.hideTemplatePreviewModal = function() {
            document.getElementById('templatePreviewModal')?.classList.remove('active'); // Hide modal with animation
        };

        // --- Simplify Agreement Modal Logic ---
        window.showSimplifyAgreementModal = function(title, simplifiedText) {
            const modal = document.getElementById('simplifyAgreementModal');
            const modalTitle = document.getElementById('simplifyAgreementTitle');
            const modalText = document.getElementById('simplifiedAgreementText');

            if (modal && modalTitle && modalText) {
                modalTitle.textContent = title;
                modalText.innerHTML = simplifiedText; // Use innerHTML to allow for formatting
                modal.classList.add('active'); // Show modal with animation
            }
        };

        window.hideSimplifyAgreementModal = function() {
            document.getElementById('simplifyAgreementModal')?.classList.remove('active'); // Hide modal with animation
        };

        // --- Project Idea Modal Logic ---
        window.showProjectIdeaModal = function(projectName, projectDescription, suggestedTemplate) {
            const modal = document.getElementById('projectIdeaModal');
            const ideaProjectName = document.getElementById('ideaProjectName');
            const ideaProjectDescription = document.getElementById('ideaProjectDescription');
            const ideaSuggestedTemplate = document.getElementById('ideaSuggestedTemplate');
            const applyButton = document.getElementById('applyProjectIdeaBtn');

            if (modal && ideaProjectName && ideaProjectDescription && ideaSuggestedTemplate && applyButton) {
                ideaProjectName.textContent = projectName;
                ideaProjectDescription.textContent = projectDescription;
                ideaSuggestedTemplate.textContent = suggestedTemplate;

                applyButton.onclick = () => {
                    document.getElementById('projectName').value = projectName;
                    document.getElementById('description').value = projectDescription;
                    const templateSelect = document.getElementById('template');
                    if (templateSelect) {
                        const optionExists = Array.from(templateSelect.options).some(option => option.value === suggestedTemplate);
                        if (optionExists) {
                            templateSelect.value = suggestedTemplate;
                        } else {
                            // If suggested template doesn't exist, select the first available or default
                            templateSelect.value = templateSelect.options[1] ? templateSelect.options[1].value : ""; 
                            window.showCustomModal('Template Not Found', `"${suggestedTemplate}" template not found. Selected a default.`, true);
                        }
                    }
                    window.hideProjectIdeaModal();
                };

                modal.classList.add('active');
            }
        };

        window.hideProjectIdeaModal = function() {
            document.getElementById('projectIdeaModal')?.classList.remove('active');
        };

        // --- Project Summary Modal (NEW) ---
        window.showProjectSummaryModal = function(title, summaryText) {
            const modal = document.getElementById('projectSummaryModal');
            const modalTitle = document.getElementById('projectSummaryTitle');
            const modalText = document.getElementById('projectSummaryText');

            if (modal && modalTitle && modalText) {
                modalTitle.textContent = title;
                modalText.innerHTML = summaryText; // Use innerHTML to allow for formatting
                modal.classList.add('active');
            }
        };

        window.hideProjectSummaryModal = function() {
            document.getElementById('projectSummaryModal')?.classList.remove('active');
        };

        // --- Email Draft Modal (NEW) ---
        let currentEmailForDraft = ''; // Store the email being drafted for

        window.openEmailDraftModal = function(emailAddress) {
            console.log("DEBUG: openEmailDraftModal received emailAddress:", emailAddress); // Added log
            currentEmailForDraft = emailAddress;
            const modal = document.getElementById('emailDraftModal');
            const modalTitle = document.getElementById('emailDraftTitle');
            const emailDraftTo = document.getElementById('emailDraftTo');
            const emailPurposeInput = document.getElementById('emailPurposeInput');
            const generatedEmailDraftOutput = document.getElementById('generatedEmailDraftOutput');
            const emailDraftStatus = document.getElementById('emailDraftStatus');

            if (modal && modalTitle && emailDraftTo && emailPurposeInput && generatedEmailDraftOutput && emailDraftStatus) {
                modalTitle.textContent = `Draft Email for ${emailAddress}`;
                emailDraftTo.textContent = emailAddress; // This is the line setting the "To" field
                emailPurposeInput.value = ''; // Clear previous input
                generatedEmailDraftOutput.value = ''; // Clear previous draft
                emailDraftStatus.classList.add('hidden'); // Hide status
                modal.classList.add('active');
            }
        };

        window.hideEmailDraftModal = function() {
            document.getElementById('emailDraftModal')?.classList.remove('active');
            currentEmailForDraft = ''; // Clear stored email
        };


        // --- Licenses View Logic ---
        function renderLicenses() {
            const licensesList = document.getElementById('licensesList');
            if (!licensesList) return;
            licensesList.innerHTML = ''; // Clear existing licenses

            appData.licenses.forEach(license => {
                const statusClass = license.verified ? 'status-live' : 'status-pending';
                const buttonText = license.verified ? 'Open in Workspace' : 'Sync License Now';
                const buttonAction = license.verified ? 'window.showCustomModal("Action", `Opening workspace for ${license.name} (simulated)...`)' : 'window.showCustomModal("Sync Initiated", `Initiating sync for ${license.name}. Please check back later. (simulated)`)';

                const licenseCard = document.createElement('div');
                licenseCard.className = 'panel bg-gray-900 border border-gray-700';
                licenseCard.innerHTML = `
                    <h4 class="mb-2">${license.name}</h4>
                    <p><strong>License ID:</strong> <span class="text-gray-400">${license.id}</span></p>
                    <p><strong>Region:</strong> <span class="text-gray-400">${license.region}</span></p>
                    <p><strong>Royalty:</strong> <span class="text-gray-400">${license.royalty}</span></p>
                    <p><strong>Activation Date:</strong> <span class="text-gray-400">${license.activationDate}</span></p>
                    <p><strong>ClaimRoot Status:</strong> <span class="text-gray-400">${license.claimStatus}</span></p>
                    <p class="project-status ${statusClass} mt-3">
                        <i class="fas ${license.verified ? 'fa-check-circle' : 'fa-hourglass-half'} mr-1"></i>
                        ${license.verified ? 'Operation Licensed & Active' : 'Awaiting Operational Registration'}
                    </p>
                    <button class="form-action-button mt-4" onclick='${buttonAction}'>
                        ${buttonText}
                    </button>
                `;
                licensesList.appendChild(licenseCard);
            });
        }

        function renderRoyaltyAgreements() {
            const agreementsList = document.getElementById('royaltyAgreementsList');
            if (!agreementsList) return;
            agreementsList.innerHTML = '';

            appData.royaltyAgreements.forEach(agreement => {
                const statusClass = agreement.status === 'Signed' ? 'status-live' : 'status-pending';
                const buttonText = agreement.status === 'Signed' ? 'View Agreement' : 'Sign via SecureSign™';
                
                const signButton = document.createElement('button');
                signButton.className = 'form-action-button mt-4';
                signButton.innerHTML = `<i class="fas ${agreement.status === 'Signed' ? 'fa-eye' : 'fa-signature'} mr-2"></i> ${buttonText}`;
                signButton.addEventListener('click', () => { // Add event listener here
                    window.showCustomModal("SecureSign™", `Redirecting to SecureSign™ for signature of "${agreement.name}". Please confirm in the pop-up. (simulated)`, true); // Now `agreement` is scoped
                    // In a real app, this would redirect to SecureSign with agreement ID
                    // window.open('securesign_portal.html?agreementId=' + agreement.id, '_blank');
                });

                const simplifyButton = document.createElement('button');
                simplifyButton.className = 'form-action-button secondary ml-2 mt-4';
                simplifyButton.id = `simplifyAgreementBtn-${agreement.id}`; // Unique ID for each button
                simplifyButton.innerHTML = `✨ Simplify Agreement`;
                const simplifyStatusId = `simplifyAgreementStatus-${agreement.id}`;
                const simplifyStatusElement = document.createElement('p');
                simplifyStatusElement.id = simplifyStatusId;
                simplifyStatusElement.className = 'text-xs text-gray-400 mt-1 hidden';


                simplifyButton.addEventListener('click', async (event) => {
                    const button = event.currentTarget;
                    if (!agreement.description.trim()) {
                        window.showCustomModal('No Text', 'There is no description to simplify for this agreement.', true);
                        return;
                    }
                    const prompt = `Simplify the following legal agreement text into plain, easy-to-understand language. Keep it concise but capture all key points. Do not include any introductory or concluding remarks outside the simplified text itself. \n\n${agreement.description}`;
                    // Use a temporary div to get the output from Gemini API, then pass to modal
                    const tempOutputDiv = document.createElement('div');
                    tempOutputDiv.id = 'tempSimplifyOutput'; // Give it an ID so callGeminiAPI can target it
                    document.body.appendChild(tempOutputDiv); // Temporarily add to DOM for targeting

                    await window.callGeminiAPI(prompt, tempOutputDiv.id, simplifyStatusId, button, 'Simplify Agreement');
                    
                    if (tempOutputDiv.textContent) {
                        window.showSimplifyAgreementModal(`${agreement.name} (Simplified)`, tempOutputDiv.textContent);
                    }
                    document.body.removeChild(tempOutputDiv); // Clean up temp div
                });

                const agreementCard = document.createElement('div');
                agreementCard.className = 'panel bg-gray-900 border border-gray-700';
                agreementCard.innerHTML = `
                    <h4 class="mb-2">${agreement.name}</h4>
                    <p class="text-gray-400 text-sm mb-2">${agreement.description}</p>
                    <p><strong>Status:</strong> <span class="project-status ${statusClass}">${agreement.status.toUpperCase()}</span></p>
                `;
                agreementCard.appendChild(signButton); // Append the sign button
                agreementCard.appendChild(simplifyButton); // Append the simplify button
                agreementCard.appendChild(simplifyStatusElement); // Append the status element

                agreementsList.appendChild(agreementCard);
            });
        }


        // --- Analytics View Logic ---
        function renderAnalyticsCharts() {
            // Deployment Trends
            const dtCtx = document.getElementById('deploymentTrendsChart')?.getContext('2d');
            if (dtCtx) {
                currentChartInstances.deploymentTrendsChart = new Chart(dtCtx, {
                    type: 'bar',
                    data: appData.analytics.deploymentTrends,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { labels: { color: document.body.classList.contains('light-mode') ? appData.colors.textDark : 'white', font: { family: 'Inter' } } } },
                        scales: {
                            x: { ticks: { color: document.body.classList.contains('light-mode') ? appData.colors.textDark : 'white' }, grid: { color: document.body.classList.contains('light-mode') ? 'rgba(0,0,0,0.1)' : 'rgba(255,255,255,0.1)' } },
                            y: { beginAtZero: true, ticks: { color: document.body.classList.contains('light-mode') ? appData.colors.textDark : 'white' }, grid: { color: document.body.classList.contains('light-mode') ? 'rgba(0,0,0,0.1)' : 'rgba(255,255,255,0.1)' } }
                        }
                    }
                });
            }

            // Royalty Distribution
            const rdCtx = document.getElementById('royaltyDistributionChart')?.getContext('2d');
            if (rdCtx) {
                currentChartInstances.royaltyDistributionChart = new Chart(rdCtx, {
                    type: 'doughnut',
                    data: appData.analytics.royaltyDistribution,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { position: 'bottom', labels: { color: document.body.classList.contains('light-mode') ? appData.colors.textDark : 'white', font: { family: 'Inter' } } } },
                    }
                });
            }

            // User Activity
            const uaCtx = document.getElementById('userActivityChart')?.getContext('2d');
            if (uaCtx) {
                currentChartInstances.userActivityChart = new Chart(uaCtx, {
                    type: 'line',
                    data: appData.analytics.userActivity,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { labels: { color: document.body.classList.contains('light-mode') ? appData.colors.textDark : 'white', font: { family: 'Inter' } } } },
                        scales: {
                            x: { ticks: { color: document.body.classList.contains('light-mode') ? appData.colors.textDark : 'white' }, grid: { color: document.body.classList.contains('light-mode') ? 'rgba(0,0,0,0.1)' : 'rgba(255,255,255,0.1)' } },
                            y: { beginAtZero: true, ticks: { color: document.body.classList.contains('light-mode') ? appData.colors.textDark : 'white' }, grid: { color: document.body.classList.contains('light-mode') ? 'rgba(0,0,0,0.1)' : 'rgba(255,255,255,0.1)' } }
                        }
                    }
                });
            }
        }

        // --- API Keys View Logic ---
        function renderApiKeysTable() {
            const apiKeysTableBody = document.getElementById('apiKeysTableBody');
            if (!apiKeysTableBody) return;
            apiKeysTableBody.innerHTML = '';

            appData.apiKeys.forEach(keyData => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="font-semibold text-gray-200">${keyData.service} <br> ${keyData.context ? `<span class="text-xs text-gray-400">(${keyData.context})</span>` : ''}</td>
                    <td class="api-key-value">${keyData.key}</td>
                    <td class="text-gray-400 text-sm">${keyData.locations.join(', ')}</td>
                `;
                apiKeysTableBody.appendChild(row);
            });
        }

        // --- Settings View Logic ---
        function loadSettings() {
            document.getElementById('displayName').value = appData.user.displayName;
            document.getElementById('email').value = appData.user.email;
            document.getElementById('defaultRegion').value = appData.user.defaultRegion;
            document.getElementById('autoClaimSetting').value = appData.user.autoClaim;

            // Render DNS records and email accounts
            renderDnsRecords();
            renderEmailAccounts();
            renderDomains();
            renderSettingsCompanySelection(); // Render company selection for settings
        }

        // Settings Tab Navigation Logic
        function showSettingsTab(tabId) {
            // Hide all sub-views
            document.querySelectorAll('.settings-sub-view').forEach(view => {
                view.classList.add('hidden');
            });
            // Show the selected sub-view
            document.getElementById(`settings-${tabId}`).classList.remove('hidden');

            // Update active button state
            document.querySelectorAll('.settings-tab-btn').forEach(btn => {
                if (btn.getAttribute('data-settings-tab') === tabId) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });

            // Re-render domain/email/dns data if switching to that tab
            if (tabId === 'domains') {
                renderDnsRecords();
                renderEmailAccounts();
                renderDomains();
                renderSettingsCompanySelection(); // Ensure selection is rendered on tab switch
            }
        }
        window.showSettingsTab = showSettingsTab; // Make global for direct calls from HTML

        // Render DNS Records
        function renderDnsRecords() {
            const dnsTableBody = document.getElementById('dnsRecordsTableBody');
            if (!dnsTableBody) return;
            dnsTableBody.innerHTML = '';
            appData.dnsRecords.forEach(record => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="font-semibold">${record.type}</td>
                    <td>${record.name}</td>
                    <td>${record.value}</td>
                    <td>${record.ttl}</td>
                    <td class="text-right">
                        <button class="text-blue-500 hover:text-blue-700 text-sm mr-2" onclick="window.showCustomModal('Edit DNS', 'Edit functionality for ${record.name} coming soon!')">Edit</button>
                        <button class="text-red-500 hover:text-red-700 text-sm" onclick="window.showCustomModal('Delete DNS', 'Delete functionality for ${record.name} coming soon!')">Delete</button>
                    </td>
                `;
                dnsTableBody.appendChild(row);
            });
        }

        // Render Domains
        function renderDomains() {
            const domainList = document.getElementById('domainList');
            const addonDomainTargetSelect = document.getElementById('addonDomainTarget');
            if (!domainList || !addonDomainTargetSelect) return;
            
            domainList.innerHTML = ''; // Clear existing
            addonDomainTargetSelect.innerHTML = '<option value="">Select Primary Domain</option>';

            appData.domains.forEach(domain => {
                const listItem = document.createElement('li');
                const statusIcon = domain.type.includes('Pending') ? 'fas fa-hourglass-half text-yellow-500' : 'fas fa-check-circle text-green-500';
                listItem.innerHTML = `<i class="${statusIcon} mr-2"></i> ${domain.name} (${domain.type})`;
                domainList.appendChild(listItem);

                // Populate add-on domain select only with primary/active domains
                if (domain.type.includes('Primary') || domain.type.includes('Subdomain')) {
                    const option = document.createElement('option');
                    option.value = domain.name;
                    option.textContent = domain.name;
                    addonDomainTargetSelect.appendChild(option);
                }
            });
        }


        // Render Email Accounts
        function renderEmailAccounts() {
            const emailAccountsTableBody = document.getElementById('emailAccountsTableBody');
            if (!emailAccountsTableBody) return;
            emailAccountsTableBody.innerHTML = '';
            appData.emailAccounts.forEach(account => {
                const row = document.createElement('tr');
                const statusClass = account.status === 'Active' ? 'text-green-500' : 'text-yellow-500';
                row.innerHTML = `
                    <td class="font-semibold">${account.email}</td>
                    <td><span class="${statusClass}">${account.status}</span></td>
                    <td class="text-right">
                        <button class="text-blue-500 hover:text-blue-700 text-sm mr-2" onclick="window.showCustomModal('Edit Email', 'Edit email ${account.email} functionality coming soon!')">Edit</button>
                        <button class="text-red-500 hover:text-red-700 text-sm" onclick="window.showCustomModal('Delete Email', 'Delete email ${account.email} functionality coming soon!')">Delete</button>
                        <button class="form-action-button text-xs px-3 py-2 mt-2 ml-2" onclick="window.openEmailDraftModal('${account.email}')">
                            ✨ Draft Email
                        </button>
                    </td>
                `;
                emailAccountsTableBody.appendChild(row);
            });
        }

        // Render company selection cards for settings panel
        function renderSettingsCompanySelection() {
            const settingsCompanySelectionGrid = document.getElementById('settingsCompanySelectionGrid');
            if (settingsCompanySelectionGrid) {
                settingsCompanySelectionGrid.innerHTML = ''; // Clear previous selections
                // Filter companyData to only show companies in the "mining" sector
                const miningCompanies = Object.entries(companyData).filter(([key, company]) => company.sector_key === "mining");

                miningCompanies.forEach(([key, company]) => {
                    const card = document.createElement('div');
                    card.className = 'company-select-card p-4 rounded-lg text-center shadow-md cursor-pointer bg-gray-700 hover:bg-gray-600 border border-gray-600'; // Added styling classes
                    card.innerHTML = `
                        <h3 class="text-lg font-bold text-white">${company.name}</h3>
                        <p class="text-gray-400 text-xs">Sector: ${sectorList[company.sector_key].name}</p>
                    `;
                    card.onclick = () => window.renderSettingsCompanyDetails(key);
                    settingsCompanySelectionGrid.appendChild(card);
                });
            }
        }

        // Render detailed company information in settings
        window.renderSettingsCompanyDetails = function(companyKey) {
            const company = companyData[companyKey];
            const detailsOutput = document.getElementById('settingsCompanyDetailsOutput');
            if (!company || !detailsOutput) return;

            detailsOutput.innerHTML = `
                <h4 class="text-xl font-bold mb-4 text-white">${company.name} Infrastructure Details</h4>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-gray-300">
                    ${Object.entries(company.details).map(([key, value]) => `
                        <div class="bg-gray-800 p-4 rounded-md border border-gray-700">
                            <strong class="text-yellow-400">${key}:</strong> ${value}
                        </div>
                    `).join('')}
                </div>
                <button class="form-action-button mt-4 bg-red-600 hover:bg-red-700" onclick="showCustomModal('Simulation', 'Advanced company management tools coming soon!', true)">
                    <i class="fas fa-cogs mr-1"></i> Manage Company Infrastructure
                </button>
            `;
            detailsOutput.classList.remove('hidden');
        };

        // --- Ecosystem Map Functions ---
        // Function to render the Ecosystem Map
        function renderEcosystemMap() {
            const sectorContainer = document.getElementById('sectorContainer')?.querySelector('.space-y-3');
            if (!sectorContainer) return;
            sectorContainer.innerHTML = ''; // Clear previous content

            // Sort sectors alphabetically by name for consistent display
            const sortedSectorKeys = Object.keys(allSectorsData).sort((a, b) => {
                return allSectorsData[a].name.localeCompare(allSectorsData[b].name);
            });

            sortedSectorKeys.forEach(sectorKey => {
                const sector = allSectorsData[sectorKey];
                const sectorDiv = document.createElement('div');
                sectorDiv.className = 'border border-gray-700 rounded-lg p-4 mb-4 bg-gray-800';
                sectorDiv.innerHTML = `
                    <button class="toggle-section-btn flex justify-between items-center w-full text-left p-2 -mx-2 -my-2 rounded-md hover:bg-gray-700 transition-colors duration-200" onclick="window.toggleSection('sector-${sectorKey}')">
                        <span class="text-blue-400 text-xl font-bold">${sector.name} <span class="text-gray-400 text-sm">(${sector.baseUrl})</span></span>
                        <span><i class="fas fa-chevron-down text-gray-400"></i></span>
                    </button>
                    <div id="sector-${sectorKey}" class="repo-content-section hidden mt-4">
                        <h4 class="text-lg font-semibold text-yellow-400 mb-2">Repository & Base URL:</h4>
                        <div class="copy-square">
                            <button class="copy-button" onclick="window.copyToClipboard(this)">Copy</button>
                            <pre class="conversation-code-block">${sector.repoName}/</pre>
                        </div>
                        <div class="copy-square mt-2">
                            <button class="copy-button" onclick="window.copyToClipboard(this)">Copy</button>
                            <pre class="conversation-code-block">${sector.baseUrl}/index</pre>
                        </div>
                        
                        <h4 class="text-lg font-semibold text-yellow-400 mb-2 mt-4">Brands & Subnodes:</h4>
                        <div class="space-y-2">
                            ${sector.brands.map(brand => `
                                <div class="border border-gray-700 rounded-md p-3 bg-gray-700">
                                    <button class="toggle-section-btn !bg-transparent !shadow-none !text-left !px-0 !py-0 !mb-0 flex justify-between items-center w-full hover:bg-gray-600 transition-colors duration-200" onclick="window.toggleSection('brand-${sectorKey}-${brand.name.replace(/ /g, '-')}')">
                                        <span class="text-white font-medium">${brand.name}</span> <span><i class="fas fa-chevron-down"></i></span>
                                    </button>
                                    <div id="brand-${sectorKey}-${brand.name.replace(/ /g, '-')}" class="repo-content-section !border-none !bg-transparent !p-0 hidden mt-2">
                                        <div class="copy-square">
                                            <button class="copy-button" onclick="window.copyToClipboard(this)">Copy</button>
                                            <pre class="conversation-code-block">${sector.baseUrl}/brands/${encodeURIComponent(brand.name.toLowerCase().replace(/ /g, '-'))}/index</pre>
                                        </div>
                                        ${brand.subnodes.map(subnode => `
                                            <div class="copy-square ml-4 mt-2">
                                                <button class="copy-button" onclick="window.copyToClipboard(this)">Copy</button>
                                                <pre class="conversation-code-block">${sector.baseUrl}/brands/${encodeURIComponent(brand.name.toLowerCase().replace(/ /g, '-'))}/${encodeURIComponent(subnode.toLowerCase().replace(/ /g, '-'))}/index</pre>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        
                        <h4 class="text-lg font-semibold text-yellow-400 mb-2 mt-4">Global Footer Pages (Example Paths):</h4>
                        <div class="space-y-2">
                            <div class="copy-square">
                                <button class="copy-button" onclick="window.copyToClipboard(this)">Copy</button>
                                <pre class="conversation-code-block">
${[
    '/privacy', '/terms', '/contact', '/copyright', '/developers',
    '/vaultmesh', '/fruitful', '/faa.zone', '/about', '/accessibility'
].map(p => `${sector.baseUrl}${p}`).join('\n')}
                                </pre>
                            </div>
                            <a href="#" class="footer-pages-link" onclick="window.showCustomModal('Global Footer', 'The global footer files are deployed from a dedicated repository and automatically linked.', true)">Learn more about Global Footer deployment</a>
                        </div>
                    </div>
                `;
                sectorContainer.appendChild(sectorDiv);
            });
        }

        // Utility function to toggle section visibility (for ecosystem map)
        window.toggleSection = function(id) {
            const element = document.getElementById(id);
            if (element) {
                element.classList.toggle('hidden');
                const icon = element.previousElementSibling.querySelector('i');
                if (icon) {
                    icon.classList.toggle('fa-chevron-down');
                    icon.classList.toggle('fa-chevron-up');
                }
            }
        };

        // Utility function to copy text to clipboard (for ecosystem map and emails)
        window.copyToClipboard = function(buttonElement) {
            const preElement = buttonElement.nextElementSibling; // Get the <pre> tag next to the button
            if (preElement && preElement.tagName === 'PRE') {
                const textToCopy = preElement.textContent.trim();
                try {
                    // Use execCommand for broader compatibility within iframes
                    const textarea = document.createElement('textarea');
                    textarea.value = textToCopy;
                    document.body.appendChild(textarea);
                    textarea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textarea);
                    
                    window.showCustomModal('Copied!', 'Text copied to clipboard.', true);
                } catch (err) {
                    console.error('Failed to copy text: ', err);
                    window.showCustomModal('Copy Failed', 'Failed to copy text. Please try manually.', true);
                }
            }
        };


        // --- Login and Signup Form Logic ---
        document.getElementById('loginForm')?.addEventListener('submit', function(event) {
            event.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            if (email === "mining.lead@example.com" && password === "password123") {
                window.showCustomModal('Login Successful!', 'Welcome back, Mining Operations Lead!', true);
                // Simulate successful login - redirect to dashboard after modal
                setTimeout(() => {
                    showView('dashboard');
                }, 1500);
            } else {
                window.showCustomModal('Login Failed', 'Invalid email or password. Please try again.', true);
            }
        });

        document.getElementById('signupForm')?.addEventListener('submit', function(event) {
            event.preventDefault();
            const name = document.getElementById('signupName').value;
            const email = document.getElementById('signupEmail').value;
            const password = document.getElementById('signupPassword').value;
            const confirmPassword = document.getElementById('signupConfirmPassword').value;

            if (password !== confirmPassword) {
                window.showCustomModal('Signup Failed', 'Passwords do not match. Please try again.', true);
                return;
            }
            if (password.length < 6) { // Basic password length validation
                window.showCustomModal('Signup Failed', 'Password must be at least 6 characters long.', true);
                return;
            }

            // Simulate successful registration
            window.showCustomModal('Registration Successful!', `Welcome, ${name}! Your account has been created. Please sign in.`, true);
            
            // Optionally clear form
            this.reset();
            // Redirect to login page after a short delay
            setTimeout(() => {
                showView('login');
            }, 1500);
        });

        // --- PayPal Integration Functions ---
        function renderPayPalButtons() {
            const paypalButtonContainer = document.getElementById('paypal-button-container');
            const paypalMessages = document.getElementById('paypal-messages');
            
            // Clear existing buttons to prevent re-rendering issues
            if (paypalButtonContainer) {
                paypalButtonContainer.innerHTML = ''; 
                paypalMessages.textContent = 'Loading PayPal...';
                paypalMessages.classList.remove('hidden', 'text-green-400', 'text-red-400'); // Reset messages
                paypalMessages.classList.add('text-yellow-400'); // Show loading message
            } else {
                console.error('PayPal button container not found!');
                return;
            }

            // Check if paypal object is available (SDK loaded)
            if (typeof paypal === 'undefined') {
                paypalMessages.textContent = 'PayPal SDK not loaded. Please try refreshing the page.';
                paypalMessages.classList.remove('text-yellow-400');
                paypalMessages.classList.add('text-red-400');
                return;
            }

            paypal.Buttons({
                // Sets up the transaction when a PayPal button is clicked
                createOrder: function(data, actions) {
                    paypalMessages.textContent = 'Creating order...';
                    paypalMessages.classList.add('text-yellow-400');
                    paypalMessages.classList.remove('text-green-400', 'text-red-400');
                    return actions.order.create({
                        purchase_units: [{
                            amount: {
                                value: '19999.00' // MineNest Enterprise License price
                            },
                            description: 'MineNest™ Enterprise License (One-time fee)',
                            soft_descriptor: 'MINENESTLICENSE' // Appears on buyer's credit card statement
                        }]
                    });
                },

                // Finalize the transaction after the buyer approves the payment
                onApprove: function(data, actions) {
                    paypalMessages.textContent = 'Processing payment...';
                    paypalMessages.classList.add('text-yellow-400');
                    paypalMessages.classList.remove('text-green-400', 'text-red-400');
                    return actions.order.capture().then(function(orderData) {
                        // Successful capture!
                        console.log('Capture result', orderData, JSON.stringify(orderData, null, 2));
                        const transaction = orderData.purchase_units[0].payments.captures[0];
                        paypalMessages.textContent = `Payment successful! Transaction ID: ${transaction.id}. Activating ClaimRoot™ License.`;
                        paypalMessages.classList.remove('text-yellow-400', 'text-red-400');
                        paypalMessages.classList.add('text-green-400');

                        // Simulate license activation and redirection
                        setTimeout(() => {
                            window.showCustomModal('License Activated!', 'Your MineNest™ Enterprise License has been successfully activated via ClaimRoot™.', true);
                            // Optionally redirect to a confirmation page or dashboard
                            // showView('dashboard'); 
                        }, 2000);
                    }).catch(function(error) {
                        console.error('Error capturing order:', error);
                        paypalMessages.textContent = 'Payment failed. Please try again or contact support.';
                        paypalMessages.classList.remove('text-yellow-400', 'text-green-400');
                        paypalMessages.classList.add('text-red-400');
                    });
                },

                // Handle cases where the buyer cancels the payment
                onCancel: function(data) {
                    console.log('Payment cancelled by user.', data);
                    paypalMessages.textContent = 'Payment cancelled. You can try again.';
                    paypalMessages.classList.remove('text-yellow-400', 'text-green-400');
                    paypalMessages.classList.add('text-red-400');
                },

                // Handle errors during the payment process
                onError: function(err) {
                    console.error('PayPal button error:', err);
                    paypalMessages.textContent = 'An error occurred with PayPal. Please try again or contact support.';
                    paypalMessages.classList.remove('text-yellow-400', 'text-green-400');
                    paypalMessages.classList.add('text-red-400');
                }
            }).render('#paypal-button-container') // Render the PayPal buttons
            .then(function() {
                // The button is rendered
                paypalMessages.textContent = 'PayPal is ready. Click to pay.';
                paypalMessages.classList.remove('text-yellow-400', 'hidden'); // Remove loading indicator
            })
            .catch(function(err) {
                // Handle cases where button rendering fails
                console.error('Failed to render PayPal buttons:', err);
                paypalMessages.textContent = 'Could not load PayPal buttons. Please check your internet connection.';
                paypalMessages.classList.remove('text-yellow-400');
                paypalMessages.classList.add('text-red-400');
            });
        }
        // END: PayPal Integration Functions


        // --- Initial App Setup ---
        document.addEventListener('DOMContentLoaded', () => {
            // First, ensure all CSS custom properties are computed and stored in appData.colors
            // This needs to happen BEFORE any charts or elements that rely on these colors are rendered.
            const rootStyles = getComputedStyle(document.documentElement);
            appData.colors.primary = rootStyles.getPropertyValue('--primary-color').trim();
            appData.colors.secondary = rootStyles.getPropertyValue('--secondary-color').trim();
            appData.colors.textDark = rootStyles.getPropertyValue('--text-color-dark').trim();
            appData.colors.borderColorDark = rootStyles.getPropertyValue('--border-color-dark').trim();
            appData.colors.accentGold = rootStyles.getPropertyValue('--accent-gold').trim();

            // Set up sidebar navigation clicks
            document.querySelectorAll('.sidebar .nav-list a').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault(); // Prevent default link behavior
                    const viewId = e.currentTarget.getAttribute('data-view');
                    if (viewId) {
                        showView(viewId);
                    }
                });
            });

            // Set up settings tab clicks
            document.querySelectorAll('.settings-tab-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const tabId = e.currentTarget.getAttribute('data-settings-tab');
                    showSettingsTab(tabId);
                });
            });


            // Set the initial view based on hash or default to dashboard
            const initialView = window.location.hash.substring(1) || 'dashboard';
            showView(initialView);

            // Populate template select dropdowns initially
            populateTemplateSelects();
            
            // Setup file upload and URL import listeners
            setupFileUpload('uploadHtml', 'htmlCode', 'htmlRefineStatus');
            setupUrlImport('importHtmlUrlBtn', 'importHtmlUrl', 'htmlCode', 'htmlRefineStatus');
            setupFileUpload('uploadCss', 'cssCode', 'cssRefineStatus');
            setupUrlImport('importCssUrlBtn', 'importCssUrl', 'cssCode', 'cssRefineStatus');
            setupFileUpload('uploadJs', 'jsCode', 'jsRefineStatus');
            setupUrlImport('importJsUrlUrlBtn', 'importJsUrl', 'jsCode', 'jsRefineStatus'); // Fix: changed ID from 'importJsUrlBtn'

            // Setup DNS Explain button listener
            document.getElementById('explainDnsBtn')?.addEventListener('click', async (event) => {
                const dnsType = document.getElementById('dnsRecordTypeInput').value.trim();
                const button = event.currentTarget;
                if (!dnsType) {
                    window.showCustomModal('Input Required', 'Please enter a DNS record type (e.g., A, CNAME, MX) to explain.');
                    return;
                }
                const prompt = `Explain what a "${dnsType}" DNS record is, its primary purpose, and a typical use case. Keep the explanation concise and easy to understand for a non-expert.`;
                await window.callGeminiAPI(prompt, 'dnsExplanationOutput', 'dnsExplainStatus', button, 'Explain DNS Type');
            });

            // Event listener for Create Email Button (MODIFIED)
            document.getElementById('createEmailBtn')?.addEventListener('click', async (event) => {
                const emailPrefix = String(document.getElementById('newEmailPrefix').value).trim();
                const emailDomain = String(document.getElementById('newEmailDomain').value).trim();
                const fullEmail = `${emailPrefix}@${emailDomain}`;

                console.log("DEBUG: Attempting to create email. Prefix:", emailPrefix, "Domain:", emailDomain, "Full Email:", fullEmail); // Debug log

                if (!emailPrefix || !emailDomain) {
                    window.showCustomModal('Input Required', 'Please enter both an email prefix and domain to create a new email account.');
                    console.warn("DEBUG: Email prefix or domain is empty. Aborting email creation."); // Debug log
                    return; // Stop execution if inputs are empty
                }

                window.showCustomModal('Email Account Creation', `Creating email account: ${fullEmail} (Simulated).`);
                appData.emailAccounts.push({ email: fullEmail, status: 'Active' });
                renderEmailAccounts(); // Re-render table
                document.getElementById('newEmailPrefix').value = ''; // Clear prefix

                // Open the email draft modal automatically after simulated creation
                window.openEmailDraftModal(fullEmail);
            });

            document.getElementById('generateEmailDraftBtn')?.addEventListener('click', async (event) => {
                const emailPurpose = document.getElementById('emailPurposeInput').value.trim();
                const button = event.currentTarget;
                if (!emailPurpose) {
                    window.showCustomModal('Input Required', 'Please enter a purpose for the email.');
                    return;
                }
                // Ensure currentEmailForDraft is correctly set from when the modal was opened
                const prompt = `Draft a professional email (max 200 words) for the purpose of "${emailPurpose}" from the email address "${currentEmailForDraft}". Focus on a clear and polite tone. Provide only the email body.`;
                await window.callGeminiAPI(prompt, 'generatedEmailDraftOutput', 'emailDraftStatus', button, 'Draft Email');
            });


            // Event Listeners for AI buttons within the integrated editor (re-mapped IDs)
            document.getElementById('editorRefineCodeBtn')?.addEventListener('click', async (event) => {
                const code = document.getElementById('editorHtmlCssCode').value;
                const button = event.currentTarget;
                document.getElementById('editorHtmlCssExplanationOutput').classList.add('hidden');
                document.getElementById('editorHtmlCssReviewOutput').classList.add('hidden');
                document.getElementById('editorGeneratedContentOutput').classList.add('hidden'); 
                if (!code.trim()) { window.showCustomModal('Input Required', 'Please paste code to refine.'); return; }
                const prompt = `Refine the following HTML/CSS code for better accessibility, semantic structure, and performance, specifically for displaying mining data, maps, or operational dashboards. Provide the refined code only, no explanations. \n\n${code}`;
                await window.callGeminiAPI(prompt, 'editorHtmlCssCode', 'editorHtmlCssStatus', button, 'Refine Code');
            });

            document.getElementById('editorExplainCodeBtn')?.addEventListener('click', async (event) => {
                const code = document.getElementById('editorHtmlCssCode').value;
                const button = event.currentTarget;
                document.getElementById('editorHtmlCssReviewOutput').classList.add('hidden');
                document.getElementById('editorGeneratedContentOutput').classList.add('hidden'); 
                if (!code.trim()) { window.showCustomModal('Input Required', 'Please paste code to explain.'); return; }
                const prompt = `Explain the key components and their purpose in the following HTML/CSS code, particularly focusing on elements related to displaying mining data, such as charts, maps, or interactive tables. Provide a high-level explanation. \n\n${code}`;
                await window.callGeminiAPI(prompt, 'editorHtmlCssExplanationOutput', 'editorHtmlCssStatus', button, 'Explain Code');
            });

            document.getElementById('editorReviewCodeBtn')?.addEventListener('click', async (event) => {
                const code = document.getElementById('editorHtmlCssCode').value;
                const button = event.currentTarget;
                document.getElementById('editorHtmlCssExplanationOutput').classList.add('hidden');
                document.getElementById('editorGeneratedContentOutput').classList.add('hidden'); 
                if (!code.trim()) { window.showCustomModal('Input Required', 'Please paste code to review.'); return; }
                const prompt = `Provide a detailed code review for the following HTML/CSS, with a focus on best practices for displaying complex mining data, interactive maps, or sensor dashboards. Point out potential issues, suggest improvements for performance (e.g., data loading, rendering), accessibility, and semantic structure. Use a clear, constructive tone. \n\n${code}`;
                await window.callGeminiAPI(prompt, 'editorHtmlCssReviewOutput', 'editorHtmlCssStatus', button, 'Review Code');
            });

            document.getElementById('editorGenerateHeadlineBtn')?.addEventListener('click', async (event) => {
                const currentContent = document.getElementById('editorHtmlCssCode').value;
                const button = event.currentTarget;
                document.getElementById('editorHtmlCssExplanationOutput').classList.add('hidden'); 
                document.getElementById('editorHtmlCssReviewOutput').classList.add('hidden');  
                if (!currentContent.trim()) {
                    window.showCustomModal('Input Required', 'Please provide some content in the editor to generate a headline.');
                    return;
                }
                const prompt = `Generate 3 concise and catchy headlines for a landing page based on the following HTML content, specifically for a mining operations context. Focus on appealing to mining professionals and summarizing the value proposition of operational efficiency. Provide only the headlines as a markdown list. \n\n${currentContent}`;
                await window.callGeminiAPI(prompt, 'editorGeneratedContentOutput', 'editorContentGenStatus', button, 'Generate Headline');
            });

            document.getElementById('editorGenerateCTABtn')?.addEventListener('click', async (event) => {
                const currentContent = document.getElementById('editorHtmlCssCode').value;
                const button = event.currentTarget;
                document.getElementById('editorHtmlCssExplanationOutput').classList.add('hidden'); 
                document.getElementById('editorHtmlCssReviewOutput').classList.add('hidden');  
                if (!currentContent.trim()) {
                    window.showCustomModal('Input Required', 'Please provide some content in the editor to generate a Call to Action.');
                    return;
                }
                const prompt = `Generate 3 compelling and concise Calls-to-Action (CTAs) for a landing page based on the following HTML content, tailored for the mining industry. Make them action-oriented and encourage conversion (e.g., schedule a demo, get a quote). Provide only the CTAs as a markdown list. \n\n${currentContent}`;
                await window.callGeminiAPI(prompt, 'editorGeneratedContentOutput', 'editorContentGenStatus', button, 'Generate CTA');
            });

            document.getElementById('editorGenerateSectionContentBtn')?.addEventListener('click', async (event) => {
                const sectionTopic = document.getElementById('editorSectionTopicInput').value.trim();
                const currentContent = document.getElementById('editorHtmlCssCode').value;
                const button = event.currentTarget;
                document.getElementById('editorHtmlCssExplanationOutput').classList.add('hidden'); 
                document.getElementById('editorHtmlCssReviewOutput').classList.add('hidden');  
                if (!sectionTopic) {
                    window.showCustomModal('Input Required', 'Please enter a topic for the section content.');
                    return;
                }
                const prompt = `Generate a 2-3 paragraph section about "${sectionTopic}" for a mining operations page. Integrate it smoothly with the existing content, which is: \n\n${currentContent}\n\n Focus on compelling language and key benefits for mining professionals.`;
                await window.callGeminiAPI(prompt, 'editorGeneratedContentOutput', 'editorContentGenStatus', button, 'Generate Section Content');
            });

            document.getElementById('editorRephraseTextBtn')?.addEventListener('click', async (event) => {
                const textToRephrase = document.getElementById('editorRephraseTextInput').value.trim();
                const button = event.currentTarget;
                document.getElementById('editorHtmlCssExplanationOutput').classList.add('hidden'); 
                document.getElementById('editorHtmlCssReviewOutput').classList.add('hidden');  
                if (!textToRephrase) {
                    window.showCustomModal('Input Required', 'Please enter text into the "Rephrase/Improve Text" field.');
                    return;
                }
                const prompt = `Rephrase and improve the following text for clarity, conciseness, and impact, suitable for a mining operations page. Provide 3 different versions as a markdown list. \n\n"${textToRephrase}"`;
                await window.callGeminiAPI(prompt, 'editorGeneratedContentOutput', 'editorContentGenStatus', button, 'Rephrase/Improve');
            });

            // Function to update the integrated editor's iframe preview
            window.updateEditorPreview = function() {
                const code = document.getElementById('editorHtmlCssCode').value;
                const previewFrame = document.getElementById('editorLivePreviewFrame');
                if (previewFrame) {
                    const doc = previewFrame.contentDocument || previewFrame.contentWindow.document;
                    doc.open();
                    doc.write(`
                        <!DOCTYPE html>
                        <html lang="en">
                        <head>
                            <meta charset="UTF-8">
                            <meta name="viewport" content="width=device-width, initial-scale=1.0">
                            <title>Preview</title>
                            <style>
                                body {
                                    margin: 0;
                                    padding: 0;
                                    display: flex;
                                    flex-direction: column;
                                    justify-content: center;
                                    align-items: center;
                                    min-height: 100vh;
                                    background-color: #f8f8f8;
                                }
                                /* Styling for the generated content within the iframe preview */
                                .generated-content-wrapper {
                                    width: 100%;
                                    max-width: 600px; /* Constrain width for better readability */
                                    padding: 20px;
                                    box-sizing: border-box;
                                }
                                .generated-content-wrapper h1, .generated-content-wrapper h2 {
                                    color: #0071e3; /* Primary Blue */
                                    margin-bottom: 0.5rem;
                                }
                                .generated-content-wrapper h1 span {
                                    color: #B8860B; /* Accent Gold */
                                }
                                .generated-content-wrapper p {
                                    color: #424245;
                                    line-height: 1.6;
                                }
                                .generated-content-wrapper button {
                                    background-color: #B8860B; /* Accent Gold Button */
                                    color: white;
                                    padding: 10px 20px;
                                    border-radius: 8px;
                                    margin-top: 15px;
                                    border: none;
                                    cursor: pointer;
                                }
                                img {
                                    width: 100%;
                                    max-width: 500px;
                                    margin-top: 15px;
                                    border-radius: 8px;
                                }
                            </style>
                        </head>
                        <body>
                            <div class="generated-content-wrapper">
                                ${code}
                            </div>
                        </body>
                        </html>
                    `);
                    doc.close();
                }
            };

            // Theme toggle logic
            const themeToggleBtn = document.getElementById('themeToggle');
            if (themeToggleBtn) {
                themeToggleBtn.addEventListener('click', () => {
                    document.body.classList.toggle('light-mode');
                    const isLightMode = document.body.classList.contains('light-mode');
                    themeToggleBtn.innerHTML = isLightMode ? '<i class="fas fa-moon"></i>' : '<i class="fas fa-sun"></i>';
                    
                    // Re-render charts to update colors based on new theme
                    renderViewContent(window.location.hash.substring(1) || 'dashboard');
                });
                // Set initial icon based on default theme
                const isLightMode = document.body.classList.contains('light-mode');
                themeToggleBtn.innerHTML = isLightMode ? '<i class="fas fa-moon"></i>' : '<i class="fas fa-sun"></i>';
            }
        });
    </script>
</body>
</html>

